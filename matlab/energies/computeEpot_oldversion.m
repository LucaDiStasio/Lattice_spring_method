function[Epotp,Epot]=computeEpot(t,N,Nx,Ny,lattice,ksthandle,kshhandle,kbehandle,indicesbulk,indicesinternalbulk,indicesF1,indicesF2,indicesF3,indicesF4,indicesF5,indicesF6,indicesinternalF1,indicesinternalF2,indicesinternalF3,indicesinternalF4,indicesinternalF5,indicesinternalF6,indicesE1,indicesE2,indicesE3,indicesE4,indicesE5,indicesE6,indicesE7,indicesE8,indicesE9,indicesE10,indicesE11,indicesE12,indicesinternalE1,indicesinternalE2,indicesinternalE3,indicesinternalE4,indicesinternalE5,indicesinternalE6,indicesinternalE7,indicesinternalE8,indicesinternalE9,indicesinternalE10,indicesinternalE11,indicesinternalE12,indicesC1,indicesC2,indicesC3,indicesC4,indicesC5,indicesC6,indicesC7,indicesC8,indicesinternalC1,indicesinternalC2,indicesinternalC3,indicesinternalC4,indicesinternalC5,indicesinternalC6,indicesinternalC7,indicesinternalC8)

%%
%        Project: Fluid - structure interaction on deformable surfaces
%         Author: Luca Di Stasio
%    Institution: ETH ZÃ¼rich
%                 Institute for Building Materials
% Research group: Computational Physics for Engineering Materials
%        Version: 0.1
%  Creation date: July 2nd, 2014
%    Last update: July 2nd, 2014
%
%    Description: 
%          Input: 
%         Output: 

%%

Epotp = zeros(N,1);

%%

% ---> structural springs

Epotp(indicesbulk,:) = 0.5*ksthandle(0.5.*(lattice(indicesbulk+1,7:9)+lattice(indicesbulk,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesbulk+1,4:6)-lattice(indicesbulk,4:6)).^2,2)))./(sqrt(sum((lattice(indicesbulk+1,7:9)-lattice(indicesbulk,7:9)).^2,2)))).*(lattice(indicesbulk+1,7:9)-lattice(indicesbulk,7:9))).^2,2) +...
                     0.5*ksthandle(0.5.*(lattice(indicesbulk-1,7:9)+lattice(indicesbulk,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesbulk-1,4:6)-lattice(indicesbulk,4:6)).^2,2)))./(sqrt(sum((lattice(indicesbulk-1,7:9)-lattice(indicesbulk,7:9)).^2,2)))).*(lattice(indicesbulk-1,7:9)-lattice(indicesbulk,7:9))).^2,2) +...
                     0.5*ksthandle(0.5.*(lattice(indicesbulk+Nx,7:9)+lattice(indicesbulk,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesbulk+Nx,4:6)-lattice(indicesbulk,4:6)).^2,2)))./(sqrt(sum((lattice(indicesbulk+Nx,7:9)-lattice(indicesbulk,7:9)).^2,2)))).*(lattice(indicesbulk+Nx,7:9)-lattice(indicesbulk,7:9))).^2,2) +...
                     0.5*ksthandle(0.5.*(lattice(indicesbulk-Nx,7:9)+lattice(indicesbulk,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesbulk-Nx,4:6)-lattice(indicesbulk,4:6)).^2,2)))./(sqrt(sum((lattice(indicesbulk-Nx,7:9)-lattice(indicesbulk,7:9)).^2,2)))).*(lattice(indicesbulk-Nx,7:9)-lattice(indicesbulk,7:9))).^2,2) +...
                     0.5*ksthandle(0.5.*(lattice(indicesbulk+Nx*Ny,7:9)+lattice(indicesbulk,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesbulk+Nx*Ny,4:6)-lattice(indicesbulk,4:6)).^2,2)))./(sqrt(sum((lattice(indicesbulk+Nx*Ny,7:9)-lattice(indicesbulk,7:9)).^2,2)))).*(lattice(indicesbulk+Nx*Ny,7:9)-lattice(indicesbulk,7:9))).^2,2) +...
                     0.5*ksthandle(0.5.*(lattice(indicesbulk-Nx*Ny,7:9)+lattice(indicesbulk,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesbulk-Nx*Ny,4:6)-lattice(indicesbulk,4:6)).^2,2)))./(sqrt(sum((lattice(indicesbulk-Nx*Ny,7:9)-lattice(indicesbulk,7:9)).^2,2)))).*(lattice(indicesbulk-Nx*Ny,7:9)-lattice(indicesbulk,7:9))).^2,2);

Epotp(indicesF1,:) = 0.5*ksthandle(0.5.*(lattice(indicesF1+1,7:9)+lattice(indicesF1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF1+1,4:6)-lattice(indicesF1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF1+1,7:9)-lattice(indicesF1,7:9)).^2,2)))).*(lattice(indicesF1+1,7:9)-lattice(indicesF1,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesF1-1,7:9)+lattice(indicesF1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF1-1,4:6)-lattice(indicesF1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF1-1,7:9)-lattice(indicesF1,7:9)).^2,2)))).*(lattice(indicesF1-1,7:9)-lattice(indicesF1,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesF1+Nx,7:9)+lattice(indicesF1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF1+Nx,4:6)-lattice(indicesF1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF1+Nx,7:9)-lattice(indicesF1,7:9)).^2,2)))).*(lattice(indicesF1+Nx,7:9)-lattice(indicesF1,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesF1-Nx,7:9)+lattice(indicesF1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF1-Nx,4:6)-lattice(indicesF1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF1-Nx,7:9)-lattice(indicesF1,7:9)).^2,2)))).*(lattice(indicesF1-Nx,7:9)-lattice(indicesF1,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesF1+Nx*Ny,7:9)+lattice(indicesF1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF1+Nx*Ny,4:6)-lattice(indicesF1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF1+Nx*Ny,7:9)-lattice(indicesF1,7:9)).^2,2)))).*(lattice(indicesF1+Nx*Ny,7:9)-lattice(indicesF1,7:9))).^2,2);

Epotp(indicesF2,:) = 0.5*ksthandle(0.5.*(lattice(indicesF2+1,7:9)+lattice(indicesF2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF2+1,4:6)-lattice(indicesF2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF2+1,7:9)-lattice(indicesF2,7:9)).^2,2)))).*(lattice(indicesF2+1,7:9)-lattice(indicesF2,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesF2-1,7:9)+lattice(indicesF2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF2-1,4:6)-lattice(indicesF2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF2-1,7:9)-lattice(indicesF2,7:9)).^2,2)))).*(lattice(indicesF2-1,7:9)-lattice(indicesF2,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesF2+Nx,7:9)+lattice(indicesF2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF2+Nx,4:6)-lattice(indicesF2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF2+Nx,7:9)-lattice(indicesF2,7:9)).^2,2)))).*(lattice(indicesF2+Nx,7:9)-lattice(indicesF2,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesF2+Nx*Ny,7:9)+lattice(indicesF2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF2+Nx*Ny,4:6)-lattice(indicesF2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF2+Nx*Ny,7:9)-lattice(indicesF2,7:9)).^2,2)))).*(lattice(indicesF2+Nx*Ny,7:9)-lattice(indicesF2,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesF2-Nx*Ny,7:9)+lattice(indicesF2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF2-Nx*Ny,4:6)-lattice(indicesF2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF2-Nx*Ny,7:9)-lattice(indicesF2,7:9)).^2,2)))).*(lattice(indicesF2-Nx*Ny,7:9)-lattice(indicesF2,7:9))).^2,2);
               
Epotp(indicesF3,:) = 0.5*ksthandle(0.5.*(lattice(indicesF3-1,7:9)+lattice(indicesF3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF3-1,4:6)-lattice(indicesF3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF3-1,7:9)-lattice(indicesF3,7:9)).^2,2)))).*(lattice(indicesF3-1,7:9)-lattice(indicesF3,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesF3+Nx,7:9)+lattice(indicesF3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF3+Nx,4:6)-lattice(indicesF3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF3+Nx,7:9)-lattice(indicesF3,7:9)).^2,2)))).*(lattice(indicesF3+Nx,7:9)-lattice(indicesF3,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesF3-Nx,7:9)+lattice(indicesF3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF3-Nx,4:6)-lattice(indicesF3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF3-Nx,7:9)-lattice(indicesF3,7:9)).^2,2)))).*(lattice(indicesF3-Nx,7:9)-lattice(indicesF3,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesF3+Nx*Ny,7:9)+lattice(indicesF3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF3+Nx*Ny,4:6)-lattice(indicesF3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF3+Nx*Ny,7:9)-lattice(indicesF3,7:9)).^2,2)))).*(lattice(indicesF3+Nx*Ny,7:9)-lattice(indicesF3,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesF3-Nx*Ny,7:9)+lattice(indicesF3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF3-Nx*Ny,4:6)-lattice(indicesF3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF3-Nx*Ny,7:9)-lattice(indicesF3,7:9)).^2,2)))).*(lattice(indicesF3-Nx*Ny,7:9)-lattice(indicesF3,7:9))).^2,2);

Epotp(indicesF4,:) = 0.5*ksthandle(0.5.*(lattice(indicesF4+1,7:9)+lattice(indicesF4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF4+1,4:6)-lattice(indicesF4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF4+1,7:9)-lattice(indicesF4,7:9)).^2,2)))).*(lattice(indicesF4+1,7:9)-lattice(indicesF4,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesF4-1,7:9)+lattice(indicesF4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF4-1,4:6)-lattice(indicesF4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF4-1,7:9)-lattice(indicesF4,7:9)).^2,2)))).*(lattice(indicesF4-1,7:9)-lattice(indicesF4,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesF4-Nx,7:9)+lattice(indicesF4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF4-Nx,4:6)-lattice(indicesF4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF4-Nx,7:9)-lattice(indicesF4,7:9)).^2,2)))).*(lattice(indicesF4-Nx,7:9)-lattice(indicesF4,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesF4+Nx*Ny,7:9)+lattice(indicesF4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF4+Nx*Ny,4:6)-lattice(indicesF4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF4+Nx*Ny,7:9)-lattice(indicesF4,7:9)).^2,2)))).*(lattice(indicesF4+Nx*Ny,7:9)-lattice(indicesF4,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesF4-Nx*Ny,7:9)+lattice(indicesF4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF4-Nx*Ny,4:6)-lattice(indicesF4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF4-Nx*Ny,7:9)-lattice(indicesF4,7:9)).^2,2)))).*(lattice(indicesF4-Nx*Ny,7:9)-lattice(indicesF4,7:9))).^2,2);
               
Epotp(indicesF5,:) = 0.5*ksthandle(0.5.*(lattice(indicesF5+1,7:9)+lattice(indicesF5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF5+1,4:6)-lattice(indicesF5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF5+1,7:9)-lattice(indicesF5,7:9)).^2,2)))).*(lattice(indicesF5+1,7:9)-lattice(indicesF5,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesF5+Nx,7:9)+lattice(indicesF5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF5+Nx,4:6)-lattice(indicesF5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF5+Nx,7:9)-lattice(indicesF5,7:9)).^2,2)))).*(lattice(indicesF5+Nx,7:9)-lattice(indicesF5,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesF5-Nx,7:9)+lattice(indicesF5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF5-Nx,4:6)-lattice(indicesF5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF5-Nx,7:9)-lattice(indicesF5,7:9)).^2,2)))).*(lattice(indicesF5-Nx,7:9)-lattice(indicesF5,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesF5+Nx*Ny,7:9)+lattice(indicesF5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF5+Nx*Ny,4:6)-lattice(indicesF5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF5+Nx*Ny,7:9)-lattice(indicesF5,7:9)).^2,2)))).*(lattice(indicesF5+Nx*Ny,7:9)-lattice(indicesF5,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesF5-Nx*Ny,7:9)+lattice(indicesF5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF5-Nx*Ny,4:6)-lattice(indicesF5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF5-Nx*Ny,7:9)-lattice(indicesF5,7:9)).^2,2)))).*(lattice(indicesF5-Nx*Ny,7:9)-lattice(indicesF5,7:9))).^2,2);
               
Epotp(indicesF6,:) = 0.5*ksthandle(0.5.*(lattice(indicesF6+1,7:9)+lattice(indicesF6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF6+1,4:6)-lattice(indicesF6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF6+1,7:9)-lattice(indicesF6,7:9)).^2,2)))).*(lattice(indicesF6+1,7:9)-lattice(indicesF6,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesF6-1,7:9)+lattice(indicesF6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF6-1,4:6)-lattice(indicesF6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF6-1,7:9)-lattice(indicesF6,7:9)).^2,2)))).*(lattice(indicesF6-1,7:9)-lattice(indicesF6,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesF6+Nx,7:9)+lattice(indicesF6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF6+Nx,4:6)-lattice(indicesF6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF6+Nx,7:9)-lattice(indicesF6,7:9)).^2,2)))).*(lattice(indicesF6+Nx,7:9)-lattice(indicesF6,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesF6-Nx,7:9)+lattice(indicesF6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF6-Nx,4:6)-lattice(indicesF6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF6-Nx,7:9)-lattice(indicesF6,7:9)).^2,2)))).*(lattice(indicesF6-Nx,7:9)-lattice(indicesF6,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesF6-Nx*Ny,7:9)+lattice(indicesF6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF6-Nx*Ny,4:6)-lattice(indicesF6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF6-Nx*Ny,7:9)-lattice(indicesF6,7:9)).^2,2)))).*(lattice(indicesF6-Nx*Ny,7:9)-lattice(indicesF6,7:9))).^2,2);

Epotp(indicesE1,:) = 0.5*ksthandle(0.5.*(lattice(indicesE1+1,7:9)+lattice(indicesE1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE1+1,4:6)-lattice(indicesE1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE1+1,7:9)-lattice(indicesE1,7:9)).^2,2)))).*(lattice(indicesE1+1,7:9)-lattice(indicesE1,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesE1-1,7:9)+lattice(indicesE1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE1-1,4:6)-lattice(indicesE1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE1-1,7:9)-lattice(indicesE1,7:9)).^2,2)))).*(lattice(indicesE1-1,7:9)-lattice(indicesE1,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesE1+Nx,7:9)+lattice(indicesE1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE1+Nx,4:6)-lattice(indicesE1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE1+Nx,7:9)-lattice(indicesE1,7:9)).^2,2)))).*(lattice(indicesE1+Nx,7:9)-lattice(indicesE1,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesE1+Nx*Ny,7:9)+lattice(indicesE1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE1+Nx*Ny,4:6)-lattice(indicesE1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE1+Nx*Ny,7:9)-lattice(indicesE1,7:9)).^2,2)))).*(lattice(indicesE1+Nx*Ny,7:9)-lattice(indicesE1,7:9))).^2,2);

Epotp(indicesE2,:) = 0.5*ksthandle(0.5.*(lattice(indicesE2-1,7:9)+lattice(indicesE2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE2-1,4:6)-lattice(indicesE2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE2-1,7:9)-lattice(indicesE2,7:9)).^2,2)))).*(lattice(indicesE2-1,7:9)-lattice(indicesE2,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesE2+Nx,7:9)+lattice(indicesE2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE2+Nx,4:6)-lattice(indicesE2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE2+Nx,7:9)-lattice(indicesE2,7:9)).^2,2)))).*(lattice(indicesE2+Nx,7:9)-lattice(indicesE2,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesE2-Nx,7:9)+lattice(indicesE2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE2-Nx,4:6)-lattice(indicesE2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE2-Nx,7:9)-lattice(indicesE2,7:9)).^2,2)))).*(lattice(indicesE2-Nx,7:9)-lattice(indicesE2,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesE2+Nx*Ny,7:9)+lattice(indicesE2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE2+Nx*Ny,4:6)-lattice(indicesE2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE2+Nx*Ny,7:9)-lattice(indicesE2,7:9)).^2,2)))).*(lattice(indicesE2+Nx*Ny,7:9)-lattice(indicesE2,7:9))).^2,2);
                 
Epotp(indicesE3,:) = 0.5*ksthandle(0.5.*(lattice(indicesE3+1,7:9)+lattice(indicesE3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE3+1,4:6)-lattice(indicesE3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE3+1,7:9)-lattice(indicesE3,7:9)).^2,2)))).*(lattice(indicesE3+1,7:9)-lattice(indicesE3,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesE3-1,7:9)+lattice(indicesE3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE3-1,4:6)-lattice(indicesE3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE3-1,7:9)-lattice(indicesE3,7:9)).^2,2)))).*(lattice(indicesE3-1,7:9)-lattice(indicesE3,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesE3-Nx,7:9)+lattice(indicesE3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE3-Nx,4:6)-lattice(indicesE3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE3-Nx,7:9)-lattice(indicesE3,7:9)).^2,2)))).*(lattice(indicesE3-Nx,7:9)-lattice(indicesE3,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesE3+Nx*Ny,7:9)+lattice(indicesE3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE3+Nx*Ny,4:6)-lattice(indicesE3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE3+Nx*Ny,7:9)-lattice(indicesE3,7:9)).^2,2)))).*(lattice(indicesE3+Nx*Ny,7:9)-lattice(indicesE3,7:9))).^2,2);

Epotp(indicesE4,:) = 0.5*ksthandle(0.5.*(lattice(indicesE4+1,7:9)+lattice(indicesE4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE4+1,4:6)-lattice(indicesE4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE4+1,7:9)-lattice(indicesE4,7:9)).^2,2)))).*(lattice(indicesE4+1,7:9)-lattice(indicesE4,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesE4+Nx,7:9)+lattice(indicesE4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE4+Nx,4:6)-lattice(indicesE4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE4+Nx,7:9)-lattice(indicesE4,7:9)).^2,2)))).*(lattice(indicesE4+Nx,7:9)-lattice(indicesE4,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesE4-Nx,7:9)+lattice(indicesE4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE4-Nx,4:6)-lattice(indicesE4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE4-Nx,7:9)-lattice(indicesE4,7:9)).^2,2)))).*(lattice(indicesE4-Nx,7:9)-lattice(indicesE4,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesE4+Nx*Ny,7:9)+lattice(indicesE4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE4+Nx*Ny,4:6)-lattice(indicesE4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE4+Nx*Ny,7:9)-lattice(indicesE4,7:9)).^2,2)))).*(lattice(indicesE4+Nx*Ny,7:9)-lattice(indicesE4,7:9))).^2,2);

Epotp(indicesE5,:) = 0.5*ksthandle(0.5.*(lattice(indicesE5+1,7:9)+lattice(indicesE5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE5+1,4:6)-lattice(indicesE5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE5+1,7:9)-lattice(indicesE5,7:9)).^2,2)))).*(lattice(indicesE5+1,7:9)-lattice(indicesE5,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesE5+Nx,7:9)+lattice(indicesE5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE5+Nx,4:6)-lattice(indicesE5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE5+Nx,7:9)-lattice(indicesE5,7:9)).^2,2)))).*(lattice(indicesE5+Nx,7:9)-lattice(indicesE5,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesE5+Nx*Ny,7:9)+lattice(indicesE5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE5+Nx*Ny,4:6)-lattice(indicesE5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE5+Nx*Ny,7:9)-lattice(indicesE5,7:9)).^2,2)))).*(lattice(indicesE5+Nx*Ny,7:9)-lattice(indicesE5,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesE5-Nx*Ny,7:9)+lattice(indicesE5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE5-Nx*Ny,4:6)-lattice(indicesE5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE5-Nx*Ny,7:9)-lattice(indicesE5,7:9)).^2,2)))).*(lattice(indicesE5-Nx*Ny,7:9)-lattice(indicesE5,7:9))).^2,2);

Epotp(indicesE6,:) = 0.5*ksthandle(0.5.*(lattice(indicesE6-1,7:9)+lattice(indicesE6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE6-1,4:6)-lattice(indicesE6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE6-1,7:9)-lattice(indicesE6,7:9)).^2,2)))).*(lattice(indicesE6-1,7:9)-lattice(indicesE6,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesE6+Nx,7:9)+lattice(indicesE6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE6+Nx,4:6)-lattice(indicesE6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE6+Nx,7:9)-lattice(indicesE6,7:9)).^2,2)))).*(lattice(indicesE6+Nx,7:9)-lattice(indicesE6,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesE6+Nx*Ny,7:9)+lattice(indicesE6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE6+Nx*Ny,4:6)-lattice(indicesE6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE6+Nx*Ny,7:9)-lattice(indicesE6,7:9)).^2,2)))).*(lattice(indicesE6+Nx*Ny,7:9)-lattice(indicesE6,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesE6-Nx*Ny,7:9)+lattice(indicesE6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE6-Nx*Ny,4:6)-lattice(indicesE6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE6-Nx*Ny,7:9)-lattice(indicesE6,7:9)).^2,2)))).*(lattice(indicesE6-Nx*Ny,7:9)-lattice(indicesE6,7:9))).^2,2);

Epotp(indicesE7,:) = 0.5*ksthandle(0.5.*(lattice(indicesE7-1,7:9)+lattice(indicesE7,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE7-1,4:6)-lattice(indicesE7,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE7-1,7:9)-lattice(indicesE7,7:9)).^2,2)))).*(lattice(indicesE7-1,7:9)-lattice(indicesE7,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesE7-Nx,7:9)+lattice(indicesE7,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE7-Nx,4:6)-lattice(indicesE7,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE7-Nx,7:9)-lattice(indicesE7,7:9)).^2,2)))).*(lattice(indicesE7-Nx,7:9)-lattice(indicesE7,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesE7+Nx*Ny,7:9)+lattice(indicesE7,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE7+Nx*Ny,4:6)-lattice(indicesE7,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE7+Nx*Ny,7:9)-lattice(indicesE7,7:9)).^2,2)))).*(lattice(indicesE7+Nx*Ny,7:9)-lattice(indicesE7,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesE7-Nx*Ny,7:9)+lattice(indicesE7,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE7-Nx*Ny,4:6)-lattice(indicesE7,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE7-Nx*Ny,7:9)-lattice(indicesE7,7:9)).^2,2)))).*(lattice(indicesE7-Nx*Ny,7:9)-lattice(indicesE7,7:9))).^2,2);

Epotp(indicesE8,:) = 0.5*ksthandle(0.5.*(lattice(indicesE8+1,7:9)+lattice(indicesE8,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE8+1,4:6)-lattice(indicesE8,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE8+1,7:9)-lattice(indicesE8,7:9)).^2,2)))).*(lattice(indicesE8+1,7:9)-lattice(indicesE8,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesE8-Nx,7:9)+lattice(indicesE8,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE8-Nx,4:6)-lattice(indicesE8,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE8-Nx,7:9)-lattice(indicesE8,7:9)).^2,2)))).*(lattice(indicesE8-Nx,7:9)-lattice(indicesE8,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesE8+Nx*Ny,7:9)+lattice(indicesE8,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE8+Nx*Ny,4:6)-lattice(indicesE8,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE8+Nx*Ny,7:9)-lattice(indicesE8,7:9)).^2,2)))).*(lattice(indicesE8+Nx*Ny,7:9)-lattice(indicesE8,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesE8-Nx*Ny,7:9)+lattice(indicesE8,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE8-Nx*Ny,4:6)-lattice(indicesE8,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE8-Nx*Ny,7:9)-lattice(indicesE8,7:9)).^2,2)))).*(lattice(indicesE8-Nx*Ny,7:9)-lattice(indicesE8,7:9))).^2,2);

Epotp(indicesE9,:) = 0.5*ksthandle(0.5.*(lattice(indicesE9+1,7:9)+lattice(indicesE9,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE9+1,4:6)-lattice(indicesE9,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE9+1,7:9)-lattice(indicesE9,7:9)).^2,2)))).*(lattice(indicesE9+1,7:9)-lattice(indicesE9,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesE9-1,7:9)+lattice(indicesE9,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE9-1,4:6)-lattice(indicesE9,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE9-1,7:9)-lattice(indicesE9,7:9)).^2,2)))).*(lattice(indicesE9-1,7:9)-lattice(indicesE9,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesE9+Nx,7:9)+lattice(indicesE9,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE9+Nx,4:6)-lattice(indicesE9,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE9+Nx,7:9)-lattice(indicesE9,7:9)).^2,2)))).*(lattice(indicesE9+Nx,7:9)-lattice(indicesE9,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesE9-Nx*Ny,7:9)+lattice(indicesE9,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE9-Nx*Ny,4:6)-lattice(indicesE9,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE9-Nx*Ny,7:9)-lattice(indicesE9,7:9)).^2,2)))).*(lattice(indicesE9-Nx*Ny,7:9)-lattice(indicesE9,7:9))).^2,2);

Epotp(indicesE10,:) = 0.5*ksthandle(0.5.*(lattice(indicesE10-1,7:9)+lattice(indicesE10,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE10-1,4:6)-lattice(indicesE10,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE10-1,7:9)-lattice(indicesE10,7:9)).^2,2)))).*(lattice(indicesE10-1,7:9)-lattice(indicesE10,7:9))).^2,2) +...
                    0.5*ksthandle(0.5.*(lattice(indicesE10+Nx,7:9)+lattice(indicesE10,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE10+Nx,4:6)-lattice(indicesE10,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE10+Nx,7:9)-lattice(indicesE10,7:9)).^2,2)))).*(lattice(indicesE10+Nx,7:9)-lattice(indicesE10,7:9))).^2,2) +...
                    0.5*ksthandle(0.5.*(lattice(indicesE10-Nx,7:9)+lattice(indicesE10,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE10-Nx,4:6)-lattice(indicesE10,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE10-Nx,7:9)-lattice(indicesE10,7:9)).^2,2)))).*(lattice(indicesE10-Nx,7:9)-lattice(indicesE10,7:9))).^2,2) +...
                    0.5*ksthandle(0.5.*(lattice(indicesE10-Nx*Ny,7:9)+lattice(indicesE10,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE10-Nx*Ny,4:6)-lattice(indicesE10,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE10-Nx*Ny,7:9)-lattice(indicesE10,7:9)).^2,2)))).*(lattice(indicesE10-Nx*Ny,7:9)-lattice(indicesE10,7:9))).^2,2);

Epotp(indicesE11,:) = 0.5*ksthandle(0.5.*(lattice(indicesE11+1,7:9)+lattice(indicesE11,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE11+1,4:6)-lattice(indicesE11,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE11+1,7:9)-lattice(indicesE11,7:9)).^2,2)))).*(lattice(indicesE11+1,7:9)-lattice(indicesE11,7:9))).^2,2) +...
                    0.5*ksthandle(0.5.*(lattice(indicesE11-1,7:9)+lattice(indicesE11,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE11-1,4:6)-lattice(indicesE11,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE11-1,7:9)-lattice(indicesE11,7:9)).^2,2)))).*(lattice(indicesE11-1,7:9)-lattice(indicesE11,7:9))).^2,2) +...
                    0.5*ksthandle(0.5.*(lattice(indicesE11-Nx,7:9)+lattice(indicesE11,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE11-Nx,4:6)-lattice(indicesE11,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE11-Nx,7:9)-lattice(indicesE11,7:9)).^2,2)))).*(lattice(indicesE11-Nx,7:9)-lattice(indicesE11,7:9))).^2,2) +...
                    0.5*ksthandle(0.5.*(lattice(indicesE11-Nx*Ny,7:9)+lattice(indicesE11,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE11-Nx*Ny,4:6)-lattice(indicesE11,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE11-Nx*Ny,7:9)-lattice(indicesE11,7:9)).^2,2)))).*(lattice(indicesE11-Nx*Ny,7:9)-lattice(indicesE11,7:9))).^2,2);

Epotp(indicesE12,:) = 0.5*ksthandle(0.5.*(lattice(indicesE12+1,7:9)+lattice(indicesE12,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE12+1,4:6)-lattice(indicesE12,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE12+1,7:9)-lattice(indicesE12,7:9)).^2,2)))).*(lattice(indicesE12+1,7:9)-lattice(indicesE12,7:9))).^2,2) +...
                    0.5*ksthandle(0.5.*(lattice(indicesE12+Nx,7:9)+lattice(indicesE12,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE12+Nx,4:6)-lattice(indicesE12,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE12+Nx,7:9)-lattice(indicesE12,7:9)).^2,2)))).*(lattice(indicesE12+Nx,7:9)-lattice(indicesE12,7:9))).^2,2) +...
                    0.5*ksthandle(0.5.*(lattice(indicesE12-Nx,7:9)+lattice(indicesE12,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE12-Nx,4:6)-lattice(indicesE12,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE12-Nx,7:9)-lattice(indicesE12,7:9)).^2,2)))).*(lattice(indicesE12-Nx,7:9)-lattice(indicesE12,7:9))).^2,2) +...
                    0.5*ksthandle(0.5.*(lattice(indicesE12-Nx*Ny,7:9)+lattice(indicesE12,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE12-Nx*Ny,4:6)-lattice(indicesE12,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE12-Nx*Ny,7:9)-lattice(indicesE12,7:9)).^2,2)))).*(lattice(indicesE12-Nx*Ny,7:9)-lattice(indicesE12,7:9))).^2,2);

Epotp(indicesC1,:) = 0.5*ksthandle(0.5.*(lattice(indicesC1+1,7:9)+lattice(indicesC1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC1+1,4:6)-lattice(indicesC1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC1+1,7:9)-lattice(indicesC1,7:9)).^2,2)))).*(lattice(indicesC1+1,7:9)-lattice(indicesC1,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesC1+Nx,7:9)+lattice(indicesC1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC1+Nx,4:6)-lattice(indicesC1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC1+Nx,7:9)-lattice(indicesC1,7:9)).^2,2)))).*(lattice(indicesC1+Nx,7:9)-lattice(indicesC1,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesC1+Nx*Ny,7:9)+lattice(indicesC1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC1+Nx*Ny,4:6)-lattice(indicesC1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC1+Nx*Ny,7:9)-lattice(indicesC1,7:9)).^2,2)))).*(lattice(indicesC1+Nx*Ny,7:9)-lattice(indicesC1,7:9))).^2,2);

Epotp(indicesC2,:) = 0.5*ksthandle(0.5.*(lattice(indicesC2-1,7:9)+lattice(indicesC2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC2-1,4:6)-lattice(indicesC2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC2-1,7:9)-lattice(indicesC2,7:9)).^2,2)))).*(lattice(indicesC2-1,7:9)-lattice(indicesC2,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesC2+Nx,7:9)+lattice(indicesC2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC2+Nx,4:6)-lattice(indicesC2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC2+Nx,7:9)-lattice(indicesC2,7:9)).^2,2)))).*(lattice(indicesC2+Nx,7:9)-lattice(indicesC2,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesC2+Nx*Ny,7:9)+lattice(indicesC2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC2+Nx*Ny,4:6)-lattice(indicesC2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC2+Nx*Ny,7:9)-lattice(indicesC2,7:9)).^2,2)))).*(lattice(indicesC2+Nx*Ny,7:9)-lattice(indicesC2,7:9))).^2,2);

Epotp(indicesC3,:) = 0.5*ksthandle(0.5.*(lattice(indicesC3-1,7:9)+lattice(indicesC3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC3-1,4:6)-lattice(indicesC3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC3-1,7:9)-lattice(indicesC3,7:9)).^2,2)))).*(lattice(indicesC3-1,7:9)-lattice(indicesC3,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesC3-Nx,7:9)+lattice(indicesC3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC3-Nx,4:6)-lattice(indicesC3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC3-Nx,7:9)-lattice(indicesC3,7:9)).^2,2)))).*(lattice(indicesC3-Nx,7:9)-lattice(indicesC3,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesC3+Nx*Ny,7:9)+lattice(indicesC3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC3+Nx*Ny,4:6)-lattice(indicesC3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC3+Nx*Ny,7:9)-lattice(indicesC3,7:9)).^2,2)))).*(lattice(indicesC3+Nx*Ny,7:9)-lattice(indicesC3,7:9))).^2,2);

Epotp(indicesC4,:) = 0.5*ksthandle(0.5.*(lattice(indicesC4+1,7:9)+lattice(indicesC4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC4+1,4:6)-lattice(indicesC4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC4+1,7:9)-lattice(indicesC4,7:9)).^2,2)))).*(lattice(indicesC4+1,7:9)-lattice(indicesC4,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesC4-Nx,7:9)+lattice(indicesC4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC4-Nx,4:6)-lattice(indicesC4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC4-Nx,7:9)-lattice(indicesC4,7:9)).^2,2)))).*(lattice(indicesC4-Nx,7:9)-lattice(indicesC4,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesC4+Nx*Ny,7:9)+lattice(indicesC4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC4+Nx*Ny,4:6)-lattice(indicesC4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC4+Nx*Ny,7:9)-lattice(indicesC4,7:9)).^2,2)))).*(lattice(indicesC4+Nx*Ny,7:9)-lattice(indicesC4,7:9))).^2,2);

Epotp(indicesC5,:) = 0.5*ksthandle(0.5.*(lattice(indicesC5+1,7:9)+lattice(indicesC5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC5+1,4:6)-lattice(indicesC5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC5+1,7:9)-lattice(indicesC5,7:9)).^2,2)))).*(lattice(indicesC5+1,7:9)-lattice(indicesC5,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesC5+Nx,7:9)+lattice(indicesC5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC5+Nx,4:6)-lattice(indicesC5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC5+Nx,7:9)-lattice(indicesC5,7:9)).^2,2)))).*(lattice(indicesC5+Nx,7:9)-lattice(indicesC5,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesC5-Nx*Ny,7:9)+lattice(indicesC5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC5-Nx*Ny,4:6)-lattice(indicesC5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC5-Nx*Ny,7:9)-lattice(indicesC5,7:9)).^2,2)))).*(lattice(indicesC5-Nx*Ny,7:9)-lattice(indicesC5,7:9))).^2,2);

Epotp(indicesC6,:) = 0.5*ksthandle(0.5.*(lattice(indicesC6-1,7:9)+lattice(indicesC6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC6-1,4:6)-lattice(indicesC6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC6-1,7:9)-lattice(indicesC6,7:9)).^2,2)))).*(lattice(indicesC6-1,7:9)-lattice(indicesC6,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesC6+Nx,7:9)+lattice(indicesC6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC6+Nx,4:6)-lattice(indicesC6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC6+Nx,7:9)-lattice(indicesC6,7:9)).^2,2)))).*(lattice(indicesC6+Nx,7:9)-lattice(indicesC6,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesC6-Nx*Ny,7:9)+lattice(indicesC6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC6-Nx*Ny,4:6)-lattice(indicesC6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC6-Nx*Ny,7:9)-lattice(indicesC6,7:9)).^2,2)))).*(lattice(indicesC6-Nx*Ny,7:9)-lattice(indicesC6,7:9))).^2,2);

Epotp(indicesC7,:) = 0.5*ksthandle(0.5.*(lattice(indicesC7-1,7:9)+lattice(indicesC7,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC7-1,4:6)-lattice(indicesC7,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC7-1,7:9)-lattice(indicesC7,7:9)).^2,2)))).*(lattice(indicesC7-1,7:9)-lattice(indicesC7,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesC7-Nx,7:9)+lattice(indicesC7,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC7-Nx,4:6)-lattice(indicesC7,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC7-Nx,7:9)-lattice(indicesC7,7:9)).^2,2)))).*(lattice(indicesC7-Nx,7:9)-lattice(indicesC7,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesC7-Nx*Ny,7:9)+lattice(indicesC7,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC7-Nx*Ny,4:6)-lattice(indicesC7,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC7-Nx*Ny,7:9)-lattice(indicesC7,7:9)).^2,2)))).*(lattice(indicesC7-Nx*Ny,7:9)-lattice(indicesC7,7:9))).^2,2);

Epotp(indicesC8,:) = 0.5*ksthandle(0.5.*(lattice(indicesC8+1,7:9)+lattice(indicesC8,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC8+1,4:6)-lattice(indicesC8,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC8+1,7:9)-lattice(indicesC8,7:9)).^2,2)))).*(lattice(indicesC8+1,7:9)-lattice(indicesC8,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesC8-Nx,7:9)+lattice(indicesC8,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC8-Nx,4:6)-lattice(indicesC8,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC8-Nx,7:9)-lattice(indicesC8,7:9)).^2,2)))).*(lattice(indicesC8-Nx,7:9)-lattice(indicesC8,7:9))).^2,2) +...
                   0.5*ksthandle(0.5.*(lattice(indicesC8-Nx*Ny,7:9)+lattice(indicesC8,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC8-Nx*Ny,4:6)-lattice(indicesC8,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC8-Nx*Ny,7:9)-lattice(indicesC8,7:9)).^2,2)))).*(lattice(indicesC8-Nx*Ny,7:9)-lattice(indicesC8,7:9))).^2,2);

%%
             
% ---> shear springs

A = -1 -Nx -Nx*Ny;
B =    -Nx -Nx*Ny;
C = +1 -Nx -Nx*Ny;
D = -1     -Nx*Ny;
E = +1     -Nx*Ny;
F = -1 +Nx -Nx*Ny;
G =    +Nx -Nx*Ny;
H = +1 +Nx -Nx*Ny;
I = -1 -Nx;
L = +1 -Nx;
M = -1 +Nx;
N = +1 +Nx;
O = -1 -Nx +Nx*Ny;
P =    -Nx +Nx*Ny;
Q = +1 -Nx +Nx*Ny;
R = -1     +Nx*Ny;
S = +1     +Nx*Ny;
T = -1 +Nx +Nx*Ny;
U =    +Nx +Nx*Ny;
V = +1 +Nx +Nx*Ny;

Epotp(indicesbulk,:) = Epotp(indicesbulk,:) + 0.5*kshhandle(0.5.*(lattice(indicesbulk+A,7:9)+lattice(indicesbulk,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesbulk+A,4:6)-lattice(indicesbulk,4:6)).^2,2)))./(sqrt(sum((lattice(indicesbulk+A,7:9)-lattice(indicesbulk,7:9)).^2,2)))).*(lattice(indicesbulk+A,7:9)-lattice(indicesbulk,7:9))).^2,2) +... % A
                                          0.5*kshhandle(0.5.*(lattice(indicesbulk+B,7:9)+lattice(indicesbulk,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesbulk+B,4:6)-lattice(indicesbulk,4:6)).^2,2)))./(sqrt(sum((lattice(indicesbulk+B,7:9)-lattice(indicesbulk,7:9)).^2,2)))).*(lattice(indicesbulk+B,7:9)-lattice(indicesbulk,7:9))).^2,2) +... % B
                                          0.5*kshhandle(0.5.*(lattice(indicesbulk+C,7:9)+lattice(indicesbulk,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesbulk+C,4:6)-lattice(indicesbulk,4:6)).^2,2)))./(sqrt(sum((lattice(indicesbulk+C,7:9)-lattice(indicesbulk,7:9)).^2,2)))).*(lattice(indicesbulk+C,7:9)-lattice(indicesbulk,7:9))).^2,2) +... % C
                                          0.5*kshhandle(0.5.*(lattice(indicesbulk+D,7:9)+lattice(indicesbulk,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesbulk+D,4:6)-lattice(indicesbulk,4:6)).^2,2)))./(sqrt(sum((lattice(indicesbulk+D,7:9)-lattice(indicesbulk,7:9)).^2,2)))).*(lattice(indicesbulk+D,7:9)-lattice(indicesbulk,7:9))).^2,2) +... % D
                                          0.5*kshhandle(0.5.*(lattice(indicesbulk+E,7:9)+lattice(indicesbulk,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesbulk+E,4:6)-lattice(indicesbulk,4:6)).^2,2)))./(sqrt(sum((lattice(indicesbulk+E,7:9)-lattice(indicesbulk,7:9)).^2,2)))).*(lattice(indicesbulk+E,7:9)-lattice(indicesbulk,7:9))).^2,2) +... % E
                                          0.5*kshhandle(0.5.*(lattice(indicesbulk+F,7:9)+lattice(indicesbulk,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesbulk+F,4:6)-lattice(indicesbulk,4:6)).^2,2)))./(sqrt(sum((lattice(indicesbulk+F,7:9)-lattice(indicesbulk,7:9)).^2,2)))).*(lattice(indicesbulk+F,7:9)-lattice(indicesbulk,7:9))).^2,2) +... % F
                                          0.5*kshhandle(0.5.*(lattice(indicesbulk+G,7:9)+lattice(indicesbulk,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesbulk+G,4:6)-lattice(indicesbulk,4:6)).^2,2)))./(sqrt(sum((lattice(indicesbulk+G,7:9)-lattice(indicesbulk,7:9)).^2,2)))).*(lattice(indicesbulk+G,7:9)-lattice(indicesbulk,7:9))).^2,2) +... % G
                                          0.5*kshhandle(0.5.*(lattice(indicesbulk+H,7:9)+lattice(indicesbulk,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesbulk+H,4:6)-lattice(indicesbulk,4:6)).^2,2)))./(sqrt(sum((lattice(indicesbulk+H,7:9)-lattice(indicesbulk,7:9)).^2,2)))).*(lattice(indicesbulk+H,7:9)-lattice(indicesbulk,7:9))).^2,2) +... % H
                                          0.5*kshhandle(0.5.*(lattice(indicesbulk+I,7:9)+lattice(indicesbulk,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesbulk+I,4:6)-lattice(indicesbulk,4:6)).^2,2)))./(sqrt(sum((lattice(indicesbulk+I,7:9)-lattice(indicesbulk,7:9)).^2,2)))).*(lattice(indicesbulk+I,7:9)-lattice(indicesbulk,7:9))).^2,2) +... % I
                                          0.5*kshhandle(0.5.*(lattice(indicesbulk+L,7:9)+lattice(indicesbulk,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesbulk+L,4:6)-lattice(indicesbulk,4:6)).^2,2)))./(sqrt(sum((lattice(indicesbulk+L,7:9)-lattice(indicesbulk,7:9)).^2,2)))).*(lattice(indicesbulk+L,7:9)-lattice(indicesbulk,7:9))).^2,2) +... % L
                                          0.5*kshhandle(0.5.*(lattice(indicesbulk+M,7:9)+lattice(indicesbulk,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesbulk+M,4:6)-lattice(indicesbulk,4:6)).^2,2)))./(sqrt(sum((lattice(indicesbulk+M,7:9)-lattice(indicesbulk,7:9)).^2,2)))).*(lattice(indicesbulk+M,7:9)-lattice(indicesbulk,7:9))).^2,2) +... % M
                                          0.5*kshhandle(0.5.*(lattice(indicesbulk+N,7:9)+lattice(indicesbulk,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesbulk+N,4:6)-lattice(indicesbulk,4:6)).^2,2)))./(sqrt(sum((lattice(indicesbulk+N,7:9)-lattice(indicesbulk,7:9)).^2,2)))).*(lattice(indicesbulk+N,7:9)-lattice(indicesbulk,7:9))).^2,2) +... % N
                                          0.5*kshhandle(0.5.*(lattice(indicesbulk+O,7:9)+lattice(indicesbulk,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesbulk+O,4:6)-lattice(indicesbulk,4:6)).^2,2)))./(sqrt(sum((lattice(indicesbulk+O,7:9)-lattice(indicesbulk,7:9)).^2,2)))).*(lattice(indicesbulk+O,7:9)-lattice(indicesbulk,7:9))).^2,2) +... % O
                                          0.5*kshhandle(0.5.*(lattice(indicesbulk+P,7:9)+lattice(indicesbulk,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesbulk+P,4:6)-lattice(indicesbulk,4:6)).^2,2)))./(sqrt(sum((lattice(indicesbulk+P,7:9)-lattice(indicesbulk,7:9)).^2,2)))).*(lattice(indicesbulk+P,7:9)-lattice(indicesbulk,7:9))).^2,2) +... % P
                                          0.5*kshhandle(0.5.*(lattice(indicesbulk+Q,7:9)+lattice(indicesbulk,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesbulk+Q,4:6)-lattice(indicesbulk,4:6)).^2,2)))./(sqrt(sum((lattice(indicesbulk+Q,7:9)-lattice(indicesbulk,7:9)).^2,2)))).*(lattice(indicesbulk+Q,7:9)-lattice(indicesbulk,7:9))).^2,2) +... % Q
                                          0.5*kshhandle(0.5.*(lattice(indicesbulk+R,7:9)+lattice(indicesbulk,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesbulk+R,4:6)-lattice(indicesbulk,4:6)).^2,2)))./(sqrt(sum((lattice(indicesbulk+R,7:9)-lattice(indicesbulk,7:9)).^2,2)))).*(lattice(indicesbulk+R,7:9)-lattice(indicesbulk,7:9))).^2,2) +... % R
                                          0.5*kshhandle(0.5.*(lattice(indicesbulk+S,7:9)+lattice(indicesbulk,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesbulk+S,4:6)-lattice(indicesbulk,4:6)).^2,2)))./(sqrt(sum((lattice(indicesbulk+S,7:9)-lattice(indicesbulk,7:9)).^2,2)))).*(lattice(indicesbulk+S,7:9)-lattice(indicesbulk,7:9))).^2,2) +... % S
                                          0.5*kshhandle(0.5.*(lattice(indicesbulk+T,7:9)+lattice(indicesbulk,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesbulk+T,4:6)-lattice(indicesbulk,4:6)).^2,2)))./(sqrt(sum((lattice(indicesbulk+T,7:9)-lattice(indicesbulk,7:9)).^2,2)))).*(lattice(indicesbulk+T,7:9)-lattice(indicesbulk,7:9))).^2,2) +... % T
                                          0.5*kshhandle(0.5.*(lattice(indicesbulk+U,7:9)+lattice(indicesbulk,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesbulk+U,4:6)-lattice(indicesbulk,4:6)).^2,2)))./(sqrt(sum((lattice(indicesbulk+U,7:9)-lattice(indicesbulk,7:9)).^2,2)))).*(lattice(indicesbulk+U,7:9)-lattice(indicesbulk,7:9))).^2,2) +... % U
                                          0.5*kshhandle(0.5.*(lattice(indicesbulk+V,7:9)+lattice(indicesbulk,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesbulk+V,4:6)-lattice(indicesbulk,4:6)).^2,2)))./(sqrt(sum((lattice(indicesbulk+V,7:9)-lattice(indicesbulk,7:9)).^2,2)))).*(lattice(indicesbulk+V,7:9)-lattice(indicesbulk,7:9))).^2,2);     % V

Epotp(indicesF1,:) = Epotp(indicesF1,:) + 0.5*kshhandle(0.5.*(lattice(indicesF1+I,7:9)+lattice(indicesF1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF1+I,4:6)-lattice(indicesF1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF1+I,7:9)-lattice(indicesF1,7:9)).^2,2)))).*(lattice(indicesF1+I,7:9)-lattice(indicesF1,7:9))).^2,2) +... % I
                                      0.5*kshhandle(0.5.*(lattice(indicesF1+L,7:9)+lattice(indicesF1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF1+L,4:6)-lattice(indicesF1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF1+L,7:9)-lattice(indicesF1,7:9)).^2,2)))).*(lattice(indicesF1+L,7:9)-lattice(indicesF1,7:9))).^2,2) +... % L
                                      0.5*kshhandle(0.5.*(lattice(indicesF1+M,7:9)+lattice(indicesF1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF1+M,4:6)-lattice(indicesF1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF1+M,7:9)-lattice(indicesF1,7:9)).^2,2)))).*(lattice(indicesF1+M,7:9)-lattice(indicesF1,7:9))).^2,2) +... % M
                                      0.5*kshhandle(0.5.*(lattice(indicesF1+N,7:9)+lattice(indicesF1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF1+N,4:6)-lattice(indicesF1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF1+N,7:9)-lattice(indicesF1,7:9)).^2,2)))).*(lattice(indicesF1+N,7:9)-lattice(indicesF1,7:9))).^2,2) +... % N
                                      0.5*kshhandle(0.5.*(lattice(indicesF1+O,7:9)+lattice(indicesF1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF1+O,4:6)-lattice(indicesF1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF1+O,7:9)-lattice(indicesF1,7:9)).^2,2)))).*(lattice(indicesF1+O,7:9)-lattice(indicesF1,7:9))).^2,2) +... % O
                                      0.5*kshhandle(0.5.*(lattice(indicesF1+P,7:9)+lattice(indicesF1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF1+P,4:6)-lattice(indicesF1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF1+P,7:9)-lattice(indicesF1,7:9)).^2,2)))).*(lattice(indicesF1+P,7:9)-lattice(indicesF1,7:9))).^2,2) +... % P
                                      0.5*kshhandle(0.5.*(lattice(indicesF1+Q,7:9)+lattice(indicesF1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF1+Q,4:6)-lattice(indicesF1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF1+Q,7:9)-lattice(indicesF1,7:9)).^2,2)))).*(lattice(indicesF1+Q,7:9)-lattice(indicesF1,7:9))).^2,2) +... % Q
                                      0.5*kshhandle(0.5.*(lattice(indicesF1+R,7:9)+lattice(indicesF1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF1+R,4:6)-lattice(indicesF1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF1+R,7:9)-lattice(indicesF1,7:9)).^2,2)))).*(lattice(indicesF1+R,7:9)-lattice(indicesF1,7:9))).^2,2) +... % R
                                      0.5*kshhandle(0.5.*(lattice(indicesF1+S,7:9)+lattice(indicesF1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF1+S,4:6)-lattice(indicesF1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF1+S,7:9)-lattice(indicesF1,7:9)).^2,2)))).*(lattice(indicesF1+S,7:9)-lattice(indicesF1,7:9))).^2,2) +... % S
                                      0.5*kshhandle(0.5.*(lattice(indicesF1+T,7:9)+lattice(indicesF1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF1+T,4:6)-lattice(indicesF1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF1+T,7:9)-lattice(indicesF1,7:9)).^2,2)))).*(lattice(indicesF1+T,7:9)-lattice(indicesF1,7:9))).^2,2) +... % T
                                      0.5*kshhandle(0.5.*(lattice(indicesF1+U,7:9)+lattice(indicesF1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF1+U,4:6)-lattice(indicesF1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF1+U,7:9)-lattice(indicesF1,7:9)).^2,2)))).*(lattice(indicesF1+U,7:9)-lattice(indicesF1,7:9))).^2,2) +... % U
                                      0.5*kshhandle(0.5.*(lattice(indicesF1+V,7:9)+lattice(indicesF1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF1+V,4:6)-lattice(indicesF1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF1+V,7:9)-lattice(indicesF1,7:9)).^2,2)))).*(lattice(indicesF1+V,7:9)-lattice(indicesF1,7:9))).^2,2);     % V

Epotp(indicesF2,:) = Epotp(indicesF2,:) + 0.5*kshhandle(0.5.*(lattice(indicesF2+D,7:9)+lattice(indicesF2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF2+D,4:6)-lattice(indicesF2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF2+D,7:9)-lattice(indicesF2,7:9)).^2,2)))).*(lattice(indicesF2+D,7:9)-lattice(indicesF2,7:9))).^2,2) +... % D
                                      0.5*kshhandle(0.5.*(lattice(indicesF2+E,7:9)+lattice(indicesF2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF2+E,4:6)-lattice(indicesF2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF2+E,7:9)-lattice(indicesF2,7:9)).^2,2)))).*(lattice(indicesF2+E,7:9)-lattice(indicesF2,7:9))).^2,2) +... % E
                                      0.5*kshhandle(0.5.*(lattice(indicesF2+F,7:9)+lattice(indicesF2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF2+F,4:6)-lattice(indicesF2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF2+F,7:9)-lattice(indicesF2,7:9)).^2,2)))).*(lattice(indicesF2+F,7:9)-lattice(indicesF2,7:9))).^2,2) +... % F
                                      0.5*kshhandle(0.5.*(lattice(indicesF2+G,7:9)+lattice(indicesF2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF2+G,4:6)-lattice(indicesF2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF2+G,7:9)-lattice(indicesF2,7:9)).^2,2)))).*(lattice(indicesF2+G,7:9)-lattice(indicesF2,7:9))).^2,2) +... % G
                                      0.5*kshhandle(0.5.*(lattice(indicesF2+H,7:9)+lattice(indicesF2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF2+H,4:6)-lattice(indicesF2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF2+H,7:9)-lattice(indicesF2,7:9)).^2,2)))).*(lattice(indicesF2+H,7:9)-lattice(indicesF2,7:9))).^2,2) +... % H
                                      0.5*kshhandle(0.5.*(lattice(indicesF2+M,7:9)+lattice(indicesF2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF2+M,4:6)-lattice(indicesF2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF2+M,7:9)-lattice(indicesF2,7:9)).^2,2)))).*(lattice(indicesF2+M,7:9)-lattice(indicesF2,7:9))).^2,2) +... % M
                                      0.5*kshhandle(0.5.*(lattice(indicesF2+N,7:9)+lattice(indicesF2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF2+N,4:6)-lattice(indicesF2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF2+N,7:9)-lattice(indicesF2,7:9)).^2,2)))).*(lattice(indicesF2+N,7:9)-lattice(indicesF2,7:9))).^2,2) +... % N
                                      0.5*kshhandle(0.5.*(lattice(indicesF2+R,7:9)+lattice(indicesF2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF2+R,4:6)-lattice(indicesF2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF2+R,7:9)-lattice(indicesF2,7:9)).^2,2)))).*(lattice(indicesF2+R,7:9)-lattice(indicesF2,7:9))).^2,2) +... % R
                                      0.5*kshhandle(0.5.*(lattice(indicesF2+S,7:9)+lattice(indicesF2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF2+S,4:6)-lattice(indicesF2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF2+S,7:9)-lattice(indicesF2,7:9)).^2,2)))).*(lattice(indicesF2+S,7:9)-lattice(indicesF2,7:9))).^2,2) +... % S
                                      0.5*kshhandle(0.5.*(lattice(indicesF2+T,7:9)+lattice(indicesF2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF2+T,4:6)-lattice(indicesF2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF2+T,7:9)-lattice(indicesF2,7:9)).^2,2)))).*(lattice(indicesF2+T,7:9)-lattice(indicesF2,7:9))).^2,2) +... % T
                                      0.5*kshhandle(0.5.*(lattice(indicesF2+U,7:9)+lattice(indicesF2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF2+U,4:6)-lattice(indicesF2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF2+U,7:9)-lattice(indicesF2,7:9)).^2,2)))).*(lattice(indicesF2+U,7:9)-lattice(indicesF2,7:9))).^2,2) +... % U
                                      0.5*kshhandle(0.5.*(lattice(indicesF2+V,7:9)+lattice(indicesF2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF2+V,4:6)-lattice(indicesF2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF2+V,7:9)-lattice(indicesF2,7:9)).^2,2)))).*(lattice(indicesF2+V,7:9)-lattice(indicesF2,7:9))).^2,2);     % V


Epotp(indicesF3,:) = Epotp(indicesF3,:) + 0.5*kshhandle(0.5.*(lattice(indicesF3+A,7:9)+lattice(indicesF3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF3+A,4:6)-lattice(indicesF3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF3+A,7:9)-lattice(indicesF3,7:9)).^2,2)))).*(lattice(indicesF3+A,7:9)-lattice(indicesF3,7:9))).^2,2) +... % A
                                      0.5*kshhandle(0.5.*(lattice(indicesF3+B,7:9)+lattice(indicesF3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF3+B,4:6)-lattice(indicesF3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF3+B,7:9)-lattice(indicesF3,7:9)).^2,2)))).*(lattice(indicesF3+B,7:9)-lattice(indicesF3,7:9))).^2,2) +... % B
                                      0.5*kshhandle(0.5.*(lattice(indicesF3+D,7:9)+lattice(indicesF3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF3+D,4:6)-lattice(indicesF3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF3+D,7:9)-lattice(indicesF3,7:9)).^2,2)))).*(lattice(indicesF3+D,7:9)-lattice(indicesF3,7:9))).^2,2) +... % D
                                      0.5*kshhandle(0.5.*(lattice(indicesF3+F,7:9)+lattice(indicesF3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF3+F,4:6)-lattice(indicesF3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF3+F,7:9)-lattice(indicesF3,7:9)).^2,2)))).*(lattice(indicesF3+F,7:9)-lattice(indicesF3,7:9))).^2,2) +... % F
                                      0.5*kshhandle(0.5.*(lattice(indicesF3+G,7:9)+lattice(indicesF3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF3+G,4:6)-lattice(indicesF3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF3+G,7:9)-lattice(indicesF3,7:9)).^2,2)))).*(lattice(indicesF3+G,7:9)-lattice(indicesF3,7:9))).^2,2) +... % G
                                      0.5*kshhandle(0.5.*(lattice(indicesF3+I,7:9)+lattice(indicesF3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF3+I,4:6)-lattice(indicesF3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF3+I,7:9)-lattice(indicesF3,7:9)).^2,2)))).*(lattice(indicesF3+I,7:9)-lattice(indicesF3,7:9))).^2,2) +... % I
                                      0.5*kshhandle(0.5.*(lattice(indicesF3+M,7:9)+lattice(indicesF3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF3+M,4:6)-lattice(indicesF3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF3+M,7:9)-lattice(indicesF3,7:9)).^2,2)))).*(lattice(indicesF3+M,7:9)-lattice(indicesF3,7:9))).^2,2) +... % M
                                      0.5*kshhandle(0.5.*(lattice(indicesF3+O,7:9)+lattice(indicesF3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF3+O,4:6)-lattice(indicesF3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF3+O,7:9)-lattice(indicesF3,7:9)).^2,2)))).*(lattice(indicesF3+O,7:9)-lattice(indicesF3,7:9))).^2,2) +... % O
                                      0.5*kshhandle(0.5.*(lattice(indicesF3+P,7:9)+lattice(indicesF3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF3+P,4:6)-lattice(indicesF3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF3+P,7:9)-lattice(indicesF3,7:9)).^2,2)))).*(lattice(indicesF3+P,7:9)-lattice(indicesF3,7:9))).^2,2) +... % P
                                      0.5*kshhandle(0.5.*(lattice(indicesF3+R,7:9)+lattice(indicesF3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF3+R,4:6)-lattice(indicesF3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF3+R,7:9)-lattice(indicesF3,7:9)).^2,2)))).*(lattice(indicesF3+R,7:9)-lattice(indicesF3,7:9))).^2,2) +... % R
                                      0.5*kshhandle(0.5.*(lattice(indicesF3+T,7:9)+lattice(indicesF3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF3+T,4:6)-lattice(indicesF3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF3+T,7:9)-lattice(indicesF3,7:9)).^2,2)))).*(lattice(indicesF3+T,7:9)-lattice(indicesF3,7:9))).^2,2) +... % T
                                      0.5*kshhandle(0.5.*(lattice(indicesF3+U,7:9)+lattice(indicesF3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF3+U,4:6)-lattice(indicesF3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF3+U,7:9)-lattice(indicesF3,7:9)).^2,2)))).*(lattice(indicesF3+U,7:9)-lattice(indicesF3,7:9))).^2,2);     % U


Epotp(indicesF4,:) = Epotp(indicesF4,:) + 0.5*kshhandle(0.5.*(lattice(indicesF4+A,7:9)+lattice(indicesF4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF4+A,4:6)-lattice(indicesF4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF4+A,7:9)-lattice(indicesF4,7:9)).^2,2)))).*(lattice(indicesF4+A,7:9)-lattice(indicesF4,7:9))).^2,2) +... % A
                                      0.5*kshhandle(0.5.*(lattice(indicesF4+B,7:9)+lattice(indicesF4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF4+B,4:6)-lattice(indicesF4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF4+B,7:9)-lattice(indicesF4,7:9)).^2,2)))).*(lattice(indicesF4+B,7:9)-lattice(indicesF4,7:9))).^2,2) +... % B
                                      0.5*kshhandle(0.5.*(lattice(indicesF4+C,7:9)+lattice(indicesF4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF4+C,4:6)-lattice(indicesF4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF4+C,7:9)-lattice(indicesF4,7:9)).^2,2)))).*(lattice(indicesF4+C,7:9)-lattice(indicesF4,7:9))).^2,2) +... % C
                                      0.5*kshhandle(0.5.*(lattice(indicesF4+D,7:9)+lattice(indicesF4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF4+D,4:6)-lattice(indicesF4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF4+D,7:9)-lattice(indicesF4,7:9)).^2,2)))).*(lattice(indicesF4+D,7:9)-lattice(indicesF4,7:9))).^2,2) +... % D
                                      0.5*kshhandle(0.5.*(lattice(indicesF4+E,7:9)+lattice(indicesF4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF4+E,4:6)-lattice(indicesF4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF4+E,7:9)-lattice(indicesF4,7:9)).^2,2)))).*(lattice(indicesF4+E,7:9)-lattice(indicesF4,7:9))).^2,2) +... % E
                                      0.5*kshhandle(0.5.*(lattice(indicesF4+I,7:9)+lattice(indicesF4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF4+I,4:6)-lattice(indicesF4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF4+I,7:9)-lattice(indicesF4,7:9)).^2,2)))).*(lattice(indicesF4+I,7:9)-lattice(indicesF4,7:9))).^2,2) +... % I
                                      0.5*kshhandle(0.5.*(lattice(indicesF4+L,7:9)+lattice(indicesF4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF4+L,4:6)-lattice(indicesF4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF4+L,7:9)-lattice(indicesF4,7:9)).^2,2)))).*(lattice(indicesF4+L,7:9)-lattice(indicesF4,7:9))).^2,2) +... % L
                                      0.5*kshhandle(0.5.*(lattice(indicesF4+O,7:9)+lattice(indicesF4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF4+O,4:6)-lattice(indicesF4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF4+O,7:9)-lattice(indicesF4,7:9)).^2,2)))).*(lattice(indicesF4+O,7:9)-lattice(indicesF4,7:9))).^2,2) +... % O
                                      0.5*kshhandle(0.5.*(lattice(indicesF4+P,7:9)+lattice(indicesF4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF4+P,4:6)-lattice(indicesF4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF4+P,7:9)-lattice(indicesF4,7:9)).^2,2)))).*(lattice(indicesF4+P,7:9)-lattice(indicesF4,7:9))).^2,2) +... % P
                                      0.5*kshhandle(0.5.*(lattice(indicesF4+Q,7:9)+lattice(indicesF4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF4+Q,4:6)-lattice(indicesF4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF4+Q,7:9)-lattice(indicesF4,7:9)).^2,2)))).*(lattice(indicesF4+Q,7:9)-lattice(indicesF4,7:9))).^2,2) +... % Q
                                      0.5*kshhandle(0.5.*(lattice(indicesF4+R,7:9)+lattice(indicesF4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF4+R,4:6)-lattice(indicesF4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF4+R,7:9)-lattice(indicesF4,7:9)).^2,2)))).*(lattice(indicesF4+R,7:9)-lattice(indicesF4,7:9))).^2,2) +... % R
                                      0.5*kshhandle(0.5.*(lattice(indicesF4+S,7:9)+lattice(indicesF4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF4+S,4:6)-lattice(indicesF4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF4+S,7:9)-lattice(indicesF4,7:9)).^2,2)))).*(lattice(indicesF4+S,7:9)-lattice(indicesF4,7:9))).^2,2);     % S


Epotp(indicesF5,:) = Epotp(indicesF5,:) + 0.5*kshhandle(0.5.*(lattice(indicesF5+B,7:9)+lattice(indicesF5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF5+B,4:6)-lattice(indicesF5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF5+B,7:9)-lattice(indicesF5,7:9)).^2,2)))).*(lattice(indicesF5+B,7:9)-lattice(indicesF5,7:9))).^2,2) +... % B
                                      0.5*kshhandle(0.5.*(lattice(indicesF5+C,7:9)+lattice(indicesF5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF5+C,4:6)-lattice(indicesF5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF5+C,7:9)-lattice(indicesF5,7:9)).^2,2)))).*(lattice(indicesF5+C,7:9)-lattice(indicesF5,7:9))).^2,2) +... % C
                                      0.5*kshhandle(0.5.*(lattice(indicesF5+E,7:9)+lattice(indicesF5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF5+E,4:6)-lattice(indicesF5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF5+E,7:9)-lattice(indicesF5,7:9)).^2,2)))).*(lattice(indicesF5+E,7:9)-lattice(indicesF5,7:9))).^2,2) +... % E
                                      0.5*kshhandle(0.5.*(lattice(indicesF5+G,7:9)+lattice(indicesF5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF5+G,4:6)-lattice(indicesF5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF5+G,7:9)-lattice(indicesF5,7:9)).^2,2)))).*(lattice(indicesF5+G,7:9)-lattice(indicesF5,7:9))).^2,2) +... % G
                                      0.5*kshhandle(0.5.*(lattice(indicesF5+H,7:9)+lattice(indicesF5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF5+H,4:6)-lattice(indicesF5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF5+H,7:9)-lattice(indicesF5,7:9)).^2,2)))).*(lattice(indicesF5+H,7:9)-lattice(indicesF5,7:9))).^2,2) +... % H
                                      0.5*kshhandle(0.5.*(lattice(indicesF5+L,7:9)+lattice(indicesF5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF5+L,4:6)-lattice(indicesF5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF5+L,7:9)-lattice(indicesF5,7:9)).^2,2)))).*(lattice(indicesF5+L,7:9)-lattice(indicesF5,7:9))).^2,2) +... % L
                                      0.5*kshhandle(0.5.*(lattice(indicesF5+N,7:9)+lattice(indicesF5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF5+N,4:6)-lattice(indicesF5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF5+N,7:9)-lattice(indicesF5,7:9)).^2,2)))).*(lattice(indicesF5+N,7:9)-lattice(indicesF5,7:9))).^2,2) +... % N
                                      0.5*kshhandle(0.5.*(lattice(indicesF5+P,7:9)+lattice(indicesF5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF5+P,4:6)-lattice(indicesF5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF5+P,7:9)-lattice(indicesF5,7:9)).^2,2)))).*(lattice(indicesF5+P,7:9)-lattice(indicesF5,7:9))).^2,2) +... % P
                                      0.5*kshhandle(0.5.*(lattice(indicesF5+Q,7:9)+lattice(indicesF5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF5+Q,4:6)-lattice(indicesF5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF5+Q,7:9)-lattice(indicesF5,7:9)).^2,2)))).*(lattice(indicesF5+Q,7:9)-lattice(indicesF5,7:9))).^2,2) +... % Q
                                      0.5*kshhandle(0.5.*(lattice(indicesF5+S,7:9)+lattice(indicesF5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF5+S,4:6)-lattice(indicesF5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF5+S,7:9)-lattice(indicesF5,7:9)).^2,2)))).*(lattice(indicesF5+S,7:9)-lattice(indicesF5,7:9))).^2,2) +... % S
                                      0.5*kshhandle(0.5.*(lattice(indicesF5+U,7:9)+lattice(indicesF5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF5+U,4:6)-lattice(indicesF5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF5+U,7:9)-lattice(indicesF5,7:9)).^2,2)))).*(lattice(indicesF5+U,7:9)-lattice(indicesF5,7:9))).^2,2) +... % U
                                      0.5*kshhandle(0.5.*(lattice(indicesF5+V,7:9)+lattice(indicesF5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF5+V,4:6)-lattice(indicesF5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF5+V,7:9)-lattice(indicesF5,7:9)).^2,2)))).*(lattice(indicesF5+V,7:9)-lattice(indicesF5,7:9))).^2,2);     % V


Epotp(indicesF6,:) = Epotp(indicesF6,:) + 0.5*kshhandle(0.5.*(lattice(indicesF6+A,7:9)+lattice(indicesF6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF6+A,4:6)-lattice(indicesF6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF6+A,7:9)-lattice(indicesF6,7:9)).^2,2)))).*(lattice(indicesF6+A,7:9)-lattice(indicesF6,7:9))).^2,2) +... % A
                                      0.5*kshhandle(0.5.*(lattice(indicesF6+B,7:9)+lattice(indicesF6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF6+B,4:6)-lattice(indicesF6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF6+B,7:9)-lattice(indicesF6,7:9)).^2,2)))).*(lattice(indicesF6+B,7:9)-lattice(indicesF6,7:9))).^2,2) +... % B
                                      0.5*kshhandle(0.5.*(lattice(indicesF6+C,7:9)+lattice(indicesF6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF6+C,4:6)-lattice(indicesF6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF6+C,7:9)-lattice(indicesF6,7:9)).^2,2)))).*(lattice(indicesF6+C,7:9)-lattice(indicesF6,7:9))).^2,2) +... % C
                                      0.5*kshhandle(0.5.*(lattice(indicesF6+D,7:9)+lattice(indicesF6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF6+D,4:6)-lattice(indicesF6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF6+D,7:9)-lattice(indicesF6,7:9)).^2,2)))).*(lattice(indicesF6+D,7:9)-lattice(indicesF6,7:9))).^2,2) +... % D
                                      0.5*kshhandle(0.5.*(lattice(indicesF6+E,7:9)+lattice(indicesF6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF6+E,4:6)-lattice(indicesF6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF6+E,7:9)-lattice(indicesF6,7:9)).^2,2)))).*(lattice(indicesF6+E,7:9)-lattice(indicesF6,7:9))).^2,2) +... % E
                                      0.5*kshhandle(0.5.*(lattice(indicesF6+F,7:9)+lattice(indicesF6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF6+F,4:6)-lattice(indicesF6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF6+F,7:9)-lattice(indicesF6,7:9)).^2,2)))).*(lattice(indicesF6+F,7:9)-lattice(indicesF6,7:9))).^2,2) +... % F
                                      0.5*kshhandle(0.5.*(lattice(indicesF6+G,7:9)+lattice(indicesF6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF6+G,4:6)-lattice(indicesF6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF6+G,7:9)-lattice(indicesF6,7:9)).^2,2)))).*(lattice(indicesF6+G,7:9)-lattice(indicesF6,7:9))).^2,2) +... % G
                                      0.5*kshhandle(0.5.*(lattice(indicesF6+H,7:9)+lattice(indicesF6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF6+H,4:6)-lattice(indicesF6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF6+H,7:9)-lattice(indicesF6,7:9)).^2,2)))).*(lattice(indicesF6+H,7:9)-lattice(indicesF6,7:9))).^2,2) +... % H
                                      0.5*kshhandle(0.5.*(lattice(indicesF6+I,7:9)+lattice(indicesF6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF6+I,4:6)-lattice(indicesF6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF6+I,7:9)-lattice(indicesF6,7:9)).^2,2)))).*(lattice(indicesF6+I,7:9)-lattice(indicesF6,7:9))).^2,2) +... % I
                                      0.5*kshhandle(0.5.*(lattice(indicesF6+L,7:9)+lattice(indicesF6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF6+L,4:6)-lattice(indicesF6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF6+L,7:9)-lattice(indicesF6,7:9)).^2,2)))).*(lattice(indicesF6+L,7:9)-lattice(indicesF6,7:9))).^2,2) +... % L
                                      0.5*kshhandle(0.5.*(lattice(indicesF6+M,7:9)+lattice(indicesF6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF6+M,4:6)-lattice(indicesF6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF6+M,7:9)-lattice(indicesF6,7:9)).^2,2)))).*(lattice(indicesF6+M,7:9)-lattice(indicesF6,7:9))).^2,2) +... % M
                                      0.5*kshhandle(0.5.*(lattice(indicesF6+N,7:9)+lattice(indicesF6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF6+N,4:6)-lattice(indicesF6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF6+N,7:9)-lattice(indicesF6,7:9)).^2,2)))).*(lattice(indicesF6+N,7:9)-lattice(indicesF6,7:9))).^2,2);     % N


Epotp(indicesE1,:) = Epotp(indicesE1,:) + 0.5*kshhandle(0.5.*(lattice(indicesE1+M,7:9)+lattice(indicesE1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE1+M,4:6)-lattice(indicesE1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE1+M,7:9)-lattice(indicesE1,7:9)).^2,2)))).*(lattice(indicesE1+M,7:9)-lattice(indicesE1,7:9))).^2,2) +... % M
                                      0.5*kshhandle(0.5.*(lattice(indicesE1+N,7:9)+lattice(indicesE1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE1+N,4:6)-lattice(indicesE1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE1+N,7:9)-lattice(indicesE1,7:9)).^2,2)))).*(lattice(indicesE1+N,7:9)-lattice(indicesE1,7:9))).^2,2) +... % N
                                      0.5*kshhandle(0.5.*(lattice(indicesE1+R,7:9)+lattice(indicesE1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE1+R,4:6)-lattice(indicesE1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE1+R,7:9)-lattice(indicesE1,7:9)).^2,2)))).*(lattice(indicesE1+R,7:9)-lattice(indicesE1,7:9))).^2,2) +... % R
                                      0.5*kshhandle(0.5.*(lattice(indicesE1+S,7:9)+lattice(indicesE1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE1+S,4:6)-lattice(indicesE1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE1+S,7:9)-lattice(indicesE1,7:9)).^2,2)))).*(lattice(indicesE1+S,7:9)-lattice(indicesE1,7:9))).^2,2) +... % S
                                      0.5*kshhandle(0.5.*(lattice(indicesE1+T,7:9)+lattice(indicesE1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE1+T,4:6)-lattice(indicesE1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE1+T,7:9)-lattice(indicesE1,7:9)).^2,2)))).*(lattice(indicesE1+T,7:9)-lattice(indicesE1,7:9))).^2,2) +... % T
                                      0.5*kshhandle(0.5.*(lattice(indicesE1+U,7:9)+lattice(indicesE1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE1+U,4:6)-lattice(indicesE1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE1+U,7:9)-lattice(indicesE1,7:9)).^2,2)))).*(lattice(indicesE1+U,7:9)-lattice(indicesE1,7:9))).^2,2) +... % U
                                      0.5*kshhandle(0.5.*(lattice(indicesE1+V,7:9)+lattice(indicesE1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE1+V,4:6)-lattice(indicesE1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE1+V,7:9)-lattice(indicesE1,7:9)).^2,2)))).*(lattice(indicesE1+V,7:9)-lattice(indicesE1,7:9))).^2,2);     % V


Epotp(indicesE2,:) = Epotp(indicesE2,:) + 0.5*kshhandle(0.5.*(lattice(indicesE2+I,7:9)+lattice(indicesE2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE2+I,4:6)-lattice(indicesE2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE2+I,7:9)-lattice(indicesE2,7:9)).^2,2)))).*(lattice(indicesE2+I,7:9)-lattice(indicesE2,7:9))).^2,2) +... % I
                                      0.5*kshhandle(0.5.*(lattice(indicesE2+M,7:9)+lattice(indicesE2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE2+M,4:6)-lattice(indicesE2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE2+M,7:9)-lattice(indicesE2,7:9)).^2,2)))).*(lattice(indicesE2+M,7:9)-lattice(indicesE2,7:9))).^2,2) +... % M
                                      0.5*kshhandle(0.5.*(lattice(indicesE2+O,7:9)+lattice(indicesE2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE2+O,4:6)-lattice(indicesE2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE2+O,7:9)-lattice(indicesE2,7:9)).^2,2)))).*(lattice(indicesE2+O,7:9)-lattice(indicesE2,7:9))).^2,2) +... % O
                                      0.5*kshhandle(0.5.*(lattice(indicesE2+P,7:9)+lattice(indicesE2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE2+P,4:6)-lattice(indicesE2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE2+P,7:9)-lattice(indicesE2,7:9)).^2,2)))).*(lattice(indicesE2+P,7:9)-lattice(indicesE2,7:9))).^2,2) +... % P
                                      0.5*kshhandle(0.5.*(lattice(indicesE2+R,7:9)+lattice(indicesE2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE2+R,4:6)-lattice(indicesE2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE2+R,7:9)-lattice(indicesE2,7:9)).^2,2)))).*(lattice(indicesE2+R,7:9)-lattice(indicesE2,7:9))).^2,2) +... % R
                                      0.5*kshhandle(0.5.*(lattice(indicesE2+T,7:9)+lattice(indicesE2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE2+T,4:6)-lattice(indicesE2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE2+T,7:9)-lattice(indicesE2,7:9)).^2,2)))).*(lattice(indicesE2+T,7:9)-lattice(indicesE2,7:9))).^2,2) +... % T
                                      0.5*kshhandle(0.5.*(lattice(indicesE2+U,7:9)+lattice(indicesE2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE2+U,4:6)-lattice(indicesE2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE2+U,7:9)-lattice(indicesE2,7:9)).^2,2)))).*(lattice(indicesE2+U,7:9)-lattice(indicesE2,7:9))).^2,2);     % U


Epotp(indicesE3,:) = Epotp(indicesE3,:) + 0.5*kshhandle(0.5.*(lattice(indicesE3+I,7:9)+lattice(indicesE3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE3+I,4:6)-lattice(indicesE3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE3+I,7:9)-lattice(indicesE3,7:9)).^2,2)))).*(lattice(indicesE3+I,7:9)-lattice(indicesE3,7:9))).^2,2) +... % I
                                      0.5*kshhandle(0.5.*(lattice(indicesE3+L,7:9)+lattice(indicesE3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE3+L,4:6)-lattice(indicesE3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE3+L,7:9)-lattice(indicesE3,7:9)).^2,2)))).*(lattice(indicesE3+L,7:9)-lattice(indicesE3,7:9))).^2,2) +... % L
                                      0.5*kshhandle(0.5.*(lattice(indicesE3+O,7:9)+lattice(indicesE3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE3+O,4:6)-lattice(indicesE3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE3+O,7:9)-lattice(indicesE3,7:9)).^2,2)))).*(lattice(indicesE3+O,7:9)-lattice(indicesE3,7:9))).^2,2) +... % O
                                      0.5*kshhandle(0.5.*(lattice(indicesE3+P,7:9)+lattice(indicesE3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE3+P,4:6)-lattice(indicesE3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE3+P,7:9)-lattice(indicesE3,7:9)).^2,2)))).*(lattice(indicesE3+P,7:9)-lattice(indicesE3,7:9))).^2,2) +... % P
                                      0.5*kshhandle(0.5.*(lattice(indicesE3+Q,7:9)+lattice(indicesE3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE3+Q,4:6)-lattice(indicesE3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE3+Q,7:9)-lattice(indicesE3,7:9)).^2,2)))).*(lattice(indicesE3+Q,7:9)-lattice(indicesE3,7:9))).^2,2) +... % Q
                                      0.5*kshhandle(0.5.*(lattice(indicesE3+R,7:9)+lattice(indicesE3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE3+R,4:6)-lattice(indicesE3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE3+R,7:9)-lattice(indicesE3,7:9)).^2,2)))).*(lattice(indicesE3+R,7:9)-lattice(indicesE3,7:9))).^2,2) +... % R
                                      0.5*kshhandle(0.5.*(lattice(indicesE3+S,7:9)+lattice(indicesE3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE3+S,4:6)-lattice(indicesE3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE3+S,7:9)-lattice(indicesE3,7:9)).^2,2)))).*(lattice(indicesE3+S,7:9)-lattice(indicesE3,7:9))).^2,2);     % S


Epotp(indicesE4,:) = Epotp(indicesE4,:) + 0.5*kshhandle(0.5.*(lattice(indicesE4+L,7:9)+lattice(indicesE4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE4+L,4:6)-lattice(indicesE4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE4+L,7:9)-lattice(indicesE4,7:9)).^2,2)))).*(lattice(indicesE4+L,7:9)-lattice(indicesE4,7:9))).^2,2) +... % L
                                      0.5*kshhandle(0.5.*(lattice(indicesE4+N,7:9)+lattice(indicesE4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE4+N,4:6)-lattice(indicesE4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE4+N,7:9)-lattice(indicesE4,7:9)).^2,2)))).*(lattice(indicesE4+N,7:9)-lattice(indicesE4,7:9))).^2,2) +... % N
                                      0.5*kshhandle(0.5.*(lattice(indicesE4+P,7:9)+lattice(indicesE4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE4+P,4:6)-lattice(indicesE4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE4+P,7:9)-lattice(indicesE4,7:9)).^2,2)))).*(lattice(indicesE4+P,7:9)-lattice(indicesE4,7:9))).^2,2) +... % P
                                      0.5*kshhandle(0.5.*(lattice(indicesE4+Q,7:9)+lattice(indicesE4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE4+Q,4:6)-lattice(indicesE4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE4+Q,7:9)-lattice(indicesE4,7:9)).^2,2)))).*(lattice(indicesE4+Q,7:9)-lattice(indicesE4,7:9))).^2,2) +... % Q
                                      0.5*kshhandle(0.5.*(lattice(indicesE4+S,7:9)+lattice(indicesE4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE4+S,4:6)-lattice(indicesE4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE4+S,7:9)-lattice(indicesE4,7:9)).^2,2)))).*(lattice(indicesE4+S,7:9)-lattice(indicesE4,7:9))).^2,2) +... % S
                                      0.5*kshhandle(0.5.*(lattice(indicesE4+U,7:9)+lattice(indicesE4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE4+U,4:6)-lattice(indicesE4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE4+U,7:9)-lattice(indicesE4,7:9)).^2,2)))).*(lattice(indicesE4+U,7:9)-lattice(indicesE4,7:9))).^2,2) +... % U
                                      0.5*kshhandle(0.5.*(lattice(indicesE4+V,7:9)+lattice(indicesE4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE4+V,4:6)-lattice(indicesE4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE4+V,7:9)-lattice(indicesE4,7:9)).^2,2)))).*(lattice(indicesE4+V,7:9)-lattice(indicesE4,7:9))).^2,2);     % V


Epotp(indicesE5,:) = Epotp(indicesE5,:) + 0.5*kshhandle(0.5.*(lattice(indicesE5+E,7:9)+lattice(indicesE5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE5+E,4:6)-lattice(indicesE5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE5+E,7:9)-lattice(indicesE5,7:9)).^2,2)))).*(lattice(indicesE5+E,7:9)-lattice(indicesE5,7:9))).^2,2) +... % E
                                      0.5*kshhandle(0.5.*(lattice(indicesE5+G,7:9)+lattice(indicesE5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE5+G,4:6)-lattice(indicesE5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE5+G,7:9)-lattice(indicesE5,7:9)).^2,2)))).*(lattice(indicesE5+G,7:9)-lattice(indicesE5,7:9))).^2,2) +... % G
                                      0.5*kshhandle(0.5.*(lattice(indicesE5+H,7:9)+lattice(indicesE5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE5+H,4:6)-lattice(indicesE5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE5+H,7:9)-lattice(indicesE5,7:9)).^2,2)))).*(lattice(indicesE5+H,7:9)-lattice(indicesE5,7:9))).^2,2) +... % H
                                      0.5*kshhandle(0.5.*(lattice(indicesE5+N,7:9)+lattice(indicesE5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE5+N,4:6)-lattice(indicesE5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE5+N,7:9)-lattice(indicesE5,7:9)).^2,2)))).*(lattice(indicesE5+N,7:9)-lattice(indicesE5,7:9))).^2,2) +... % N
                                      0.5*kshhandle(0.5.*(lattice(indicesE5+S,7:9)+lattice(indicesE5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE5+S,4:6)-lattice(indicesE5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE5+S,7:9)-lattice(indicesE5,7:9)).^2,2)))).*(lattice(indicesE5+S,7:9)-lattice(indicesE5,7:9))).^2,2) +... % S
                                      0.5*kshhandle(0.5.*(lattice(indicesE5+U,7:9)+lattice(indicesE5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE5+U,4:6)-lattice(indicesE5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE5+U,7:9)-lattice(indicesE5,7:9)).^2,2)))).*(lattice(indicesE5+U,7:9)-lattice(indicesE5,7:9))).^2,2) +... % U
                                      0.5*kshhandle(0.5.*(lattice(indicesE5+V,7:9)+lattice(indicesE5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE5+V,4:6)-lattice(indicesE5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE5+V,7:9)-lattice(indicesE5,7:9)).^2,2)))).*(lattice(indicesE5+V,7:9)-lattice(indicesE5,7:9))).^2,2);     % V


Epotp(indicesE6,:) = Epotp(indicesE6,:) + 0.5*kshhandle(0.5.*(lattice(indicesE6+D,7:9)+lattice(indicesE6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE6+D,4:6)-lattice(indicesE6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE6+D,7:9)-lattice(indicesE6,7:9)).^2,2)))).*(lattice(indicesE6+D,7:9)-lattice(indicesE6,7:9))).^2,2) +... % D
                                      0.5*kshhandle(0.5.*(lattice(indicesE6+F,7:9)+lattice(indicesE6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE6+F,4:6)-lattice(indicesE6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE6+F,7:9)-lattice(indicesE6,7:9)).^2,2)))).*(lattice(indicesE6+F,7:9)-lattice(indicesE6,7:9))).^2,2) +... % F
                                      0.5*kshhandle(0.5.*(lattice(indicesE6+G,7:9)+lattice(indicesE6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE6+G,4:6)-lattice(indicesE6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE6+G,7:9)-lattice(indicesE6,7:9)).^2,2)))).*(lattice(indicesE6+G,7:9)-lattice(indicesE6,7:9))).^2,2) +... % G
                                      0.5*kshhandle(0.5.*(lattice(indicesE6+M,7:9)+lattice(indicesE6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE6+M,4:6)-lattice(indicesE6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE6+M,7:9)-lattice(indicesE6,7:9)).^2,2)))).*(lattice(indicesE6+M,7:9)-lattice(indicesE6,7:9))).^2,2) +... % M
                                      0.5*kshhandle(0.5.*(lattice(indicesE6+R,7:9)+lattice(indicesE6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE6+R,4:6)-lattice(indicesE6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE6+R,7:9)-lattice(indicesE6,7:9)).^2,2)))).*(lattice(indicesE6+R,7:9)-lattice(indicesE6,7:9))).^2,2) +... % R
                                      0.5*kshhandle(0.5.*(lattice(indicesE6+T,7:9)+lattice(indicesE6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE6+T,4:6)-lattice(indicesE6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE6+T,7:9)-lattice(indicesE6,7:9)).^2,2)))).*(lattice(indicesE6+T,7:9)-lattice(indicesE6,7:9))).^2,2) +... % T
                                      0.5*kshhandle(0.5.*(lattice(indicesE6+U,7:9)+lattice(indicesE6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE6+U,4:6)-lattice(indicesE6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE6+U,7:9)-lattice(indicesE6,7:9)).^2,2)))).*(lattice(indicesE6+U,7:9)-lattice(indicesE6,7:9))).^2,2);     % U


Epotp(indicesE7,:) = Epotp(indicesE7,:) + 0.5*kshhandle(0.5.*(lattice(indicesE7+A,7:9)+lattice(indicesE7,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE7+A,4:6)-lattice(indicesE7,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE7+A,7:9)-lattice(indicesE7,7:9)).^2,2)))).*(lattice(indicesE7+A,7:9)-lattice(indicesE7,7:9))).^2,2) +... % A
                                      0.5*kshhandle(0.5.*(lattice(indicesE7+B,7:9)+lattice(indicesE7,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE7+B,4:6)-lattice(indicesE7,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE7+B,7:9)-lattice(indicesE7,7:9)).^2,2)))).*(lattice(indicesE7+B,7:9)-lattice(indicesE7,7:9))).^2,2) +... % B
                                      0.5*kshhandle(0.5.*(lattice(indicesE7+D,7:9)+lattice(indicesE7,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE7+D,4:6)-lattice(indicesE7,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE7+D,7:9)-lattice(indicesE7,7:9)).^2,2)))).*(lattice(indicesE7+D,7:9)-lattice(indicesE7,7:9))).^2,2) +... % D
                                      0.5*kshhandle(0.5.*(lattice(indicesE7+I,7:9)+lattice(indicesE7,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE7+I,4:6)-lattice(indicesE7,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE7+I,7:9)-lattice(indicesE7,7:9)).^2,2)))).*(lattice(indicesE7+I,7:9)-lattice(indicesE7,7:9))).^2,2) +... % I
                                      0.5*kshhandle(0.5.*(lattice(indicesE7+O,7:9)+lattice(indicesE7,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE7+O,4:6)-lattice(indicesE7,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE7+O,7:9)-lattice(indicesE7,7:9)).^2,2)))).*(lattice(indicesE7+O,7:9)-lattice(indicesE7,7:9))).^2,2) +... % O
                                      0.5*kshhandle(0.5.*(lattice(indicesE7+P,7:9)+lattice(indicesE7,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE7+P,4:6)-lattice(indicesE7,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE7+P,7:9)-lattice(indicesE7,7:9)).^2,2)))).*(lattice(indicesE7+P,7:9)-lattice(indicesE7,7:9))).^2,2) +... % P
                                      0.5*kshhandle(0.5.*(lattice(indicesE7+R,7:9)+lattice(indicesE7,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE7+R,4:6)-lattice(indicesE7,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE7+R,7:9)-lattice(indicesE7,7:9)).^2,2)))).*(lattice(indicesE7+R,7:9)-lattice(indicesE7,7:9))).^2,2);     % R


Epotp(indicesE8,:) = Epotp(indicesE8,:) + 0.5*kshhandle(0.5.*(lattice(indicesE8+B,7:9)+lattice(indicesE8,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE8+B,4:6)-lattice(indicesE8,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE8+B,7:9)-lattice(indicesE8,7:9)).^2,2)))).*(lattice(indicesE8+B,7:9)-lattice(indicesE8,7:9))).^2,2) +... % B
                                      0.5*kshhandle(0.5.*(lattice(indicesE8+C,7:9)+lattice(indicesE8,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE8+C,4:6)-lattice(indicesE8,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE8+C,7:9)-lattice(indicesE8,7:9)).^2,2)))).*(lattice(indicesE8+C,7:9)-lattice(indicesE8,7:9))).^2,2) +... % C
                                      0.5*kshhandle(0.5.*(lattice(indicesE8+E,7:9)+lattice(indicesE8,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE8+E,4:6)-lattice(indicesE8,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE8+E,7:9)-lattice(indicesE8,7:9)).^2,2)))).*(lattice(indicesE8+E,7:9)-lattice(indicesE8,7:9))).^2,2) +... % E
                                      0.5*kshhandle(0.5.*(lattice(indicesE8+L,7:9)+lattice(indicesE8,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE8+L,4:6)-lattice(indicesE8,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE8+L,7:9)-lattice(indicesE8,7:9)).^2,2)))).*(lattice(indicesE8+L,7:9)-lattice(indicesE8,7:9))).^2,2) +... % L
                                      0.5*kshhandle(0.5.*(lattice(indicesE8+P,7:9)+lattice(indicesE8,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE8+P,4:6)-lattice(indicesE8,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE8+P,7:9)-lattice(indicesE8,7:9)).^2,2)))).*(lattice(indicesE8+P,7:9)-lattice(indicesE8,7:9))).^2,2) +... % P
                                      0.5*kshhandle(0.5.*(lattice(indicesE8+Q,7:9)+lattice(indicesE8,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE8+Q,4:6)-lattice(indicesE8,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE8+Q,7:9)-lattice(indicesE8,7:9)).^2,2)))).*(lattice(indicesE8+Q,7:9)-lattice(indicesE8,7:9))).^2,2) +... % Q
                                      0.5*kshhandle(0.5.*(lattice(indicesE8+S,7:9)+lattice(indicesE8,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE8+S,4:6)-lattice(indicesE8,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE8+S,7:9)-lattice(indicesE8,7:9)).^2,2)))).*(lattice(indicesE8+S,7:9)-lattice(indicesE8,7:9))).^2,2);     % S


Epotp(indicesE9,:) = Epotp(indicesE9,:) + 0.5*kshhandle(0.5.*(lattice(indicesE9+D,7:9)+lattice(indicesE9,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE9+D,4:6)-lattice(indicesE9,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE9+D,7:9)-lattice(indicesE9,7:9)).^2,2)))).*(lattice(indicesE9+D,7:9)-lattice(indicesE9,7:9))).^2,2) +... % D
                                      0.5*kshhandle(0.5.*(lattice(indicesE9+E,7:9)+lattice(indicesE9,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE9+E,4:6)-lattice(indicesE9,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE9+E,7:9)-lattice(indicesE9,7:9)).^2,2)))).*(lattice(indicesE9+E,7:9)-lattice(indicesE9,7:9))).^2,2) +... % E
                                      0.5*kshhandle(0.5.*(lattice(indicesE9+F,7:9)+lattice(indicesE9,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE9+F,4:6)-lattice(indicesE9,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE9+F,7:9)-lattice(indicesE9,7:9)).^2,2)))).*(lattice(indicesE9+F,7:9)-lattice(indicesE9,7:9))).^2,2) +... % F
                                      0.5*kshhandle(0.5.*(lattice(indicesE9+G,7:9)+lattice(indicesE9,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE9+G,4:6)-lattice(indicesE9,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE9+G,7:9)-lattice(indicesE9,7:9)).^2,2)))).*(lattice(indicesE9+G,7:9)-lattice(indicesE9,7:9))).^2,2) +... % G
                                      0.5*kshhandle(0.5.*(lattice(indicesE9+H,7:9)+lattice(indicesE9,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE9+H,4:6)-lattice(indicesE9,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE9+H,7:9)-lattice(indicesE9,7:9)).^2,2)))).*(lattice(indicesE9+H,7:9)-lattice(indicesE9,7:9))).^2,2) +... % H
                                      0.5*kshhandle(0.5.*(lattice(indicesE9+M,7:9)+lattice(indicesE9,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE9+M,4:6)-lattice(indicesE9,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE9+M,7:9)-lattice(indicesE9,7:9)).^2,2)))).*(lattice(indicesE9+M,7:9)-lattice(indicesE9,7:9))).^2,2) +... % M
                                      0.5*kshhandle(0.5.*(lattice(indicesE9+N,7:9)+lattice(indicesE9,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE9+N,4:6)-lattice(indicesE9,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE9+N,7:9)-lattice(indicesE9,7:9)).^2,2)))).*(lattice(indicesE9+N,7:9)-lattice(indicesE9,7:9))).^2,2);     % N


Epotp(indicesE10,:) = Epotp(indicesE10,:) + 0.5*kshhandle(0.5.*(lattice(indicesE10+A,7:9)+lattice(indicesE10,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE10+A,4:6)-lattice(indicesE10,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE10+A,7:9)-lattice(indicesE10,7:9)).^2,2)))).*(lattice(indicesE10+A,7:9)-lattice(indicesE10,7:9))).^2,2) +... % A
                                        0.5*kshhandle(0.5.*(lattice(indicesE10+B,7:9)+lattice(indicesE10,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE10+B,4:6)-lattice(indicesE10,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE10+B,7:9)-lattice(indicesE10,7:9)).^2,2)))).*(lattice(indicesE10+B,7:9)-lattice(indicesE10,7:9))).^2,2) +... % B
                                        0.5*kshhandle(0.5.*(lattice(indicesE10+D,7:9)+lattice(indicesE10,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE10+D,4:6)-lattice(indicesE10,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE10+D,7:9)-lattice(indicesE10,7:9)).^2,2)))).*(lattice(indicesE10+D,7:9)-lattice(indicesE10,7:9))).^2,2) +... % D
                                        0.5*kshhandle(0.5.*(lattice(indicesE10+F,7:9)+lattice(indicesE10,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE10+F,4:6)-lattice(indicesE10,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE10+F,7:9)-lattice(indicesE10,7:9)).^2,2)))).*(lattice(indicesE10+F,7:9)-lattice(indicesE10,7:9))).^2,2) +... % F
                                        0.5*kshhandle(0.5.*(lattice(indicesE10+G,7:9)+lattice(indicesE10,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE10+G,4:6)-lattice(indicesE10,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE10+G,7:9)-lattice(indicesE10,7:9)).^2,2)))).*(lattice(indicesE10+G,7:9)-lattice(indicesE10,7:9))).^2,2) +... % G
                                        0.5*kshhandle(0.5.*(lattice(indicesE10+I,7:9)+lattice(indicesE10,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE10+I,4:6)-lattice(indicesE10,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE10+I,7:9)-lattice(indicesE10,7:9)).^2,2)))).*(lattice(indicesE10+I,7:9)-lattice(indicesE10,7:9))).^2,2) +... % I
                                        0.5*kshhandle(0.5.*(lattice(indicesE10+M,7:9)+lattice(indicesE10,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE10+M,4:6)-lattice(indicesE10,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE10+M,7:9)-lattice(indicesE10,7:9)).^2,2)))).*(lattice(indicesE10+M,7:9)-lattice(indicesE10,7:9))).^2,2);     % M


Epotp(indicesE11,:) = Epotp(indicesE11,:) + 0.5*kshhandle(0.5.*(lattice(indicesE11+A,7:9)+lattice(indicesE11,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE11+A,4:6)-lattice(indicesE11,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE11+A,7:9)-lattice(indicesE11,7:9)).^2,2)))).*(lattice(indicesE11+A,7:9)-lattice(indicesE11,7:9))).^2,2) +... % A
                                        0.5*kshhandle(0.5.*(lattice(indicesE11+B,7:9)+lattice(indicesE11,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE11+B,4:6)-lattice(indicesE11,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE11+B,7:9)-lattice(indicesE11,7:9)).^2,2)))).*(lattice(indicesE11+B,7:9)-lattice(indicesE11,7:9))).^2,2) +... % B
                                        0.5*kshhandle(0.5.*(lattice(indicesE11+C,7:9)+lattice(indicesE11,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE11+C,4:6)-lattice(indicesE11,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE11+C,7:9)-lattice(indicesE11,7:9)).^2,2)))).*(lattice(indicesE11+C,7:9)-lattice(indicesE11,7:9))).^2,2) +... % C
                                        0.5*kshhandle(0.5.*(lattice(indicesE11+D,7:9)+lattice(indicesE11,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE11+D,4:6)-lattice(indicesE11,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE11+D,7:9)-lattice(indicesE11,7:9)).^2,2)))).*(lattice(indicesE11+D,7:9)-lattice(indicesE11,7:9))).^2,2) +... % D
                                        0.5*kshhandle(0.5.*(lattice(indicesE11+E,7:9)+lattice(indicesE11,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE11+E,4:6)-lattice(indicesE11,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE11+E,7:9)-lattice(indicesE11,7:9)).^2,2)))).*(lattice(indicesE11+E,7:9)-lattice(indicesE11,7:9))).^2,2) +... % E
                                        0.5*kshhandle(0.5.*(lattice(indicesE11+I,7:9)+lattice(indicesE11,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE11+I,4:6)-lattice(indicesE11,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE11+I,7:9)-lattice(indicesE11,7:9)).^2,2)))).*(lattice(indicesE11+I,7:9)-lattice(indicesE11,7:9))).^2,2) +... % I
                                        0.5*kshhandle(0.5.*(lattice(indicesE11+L,7:9)+lattice(indicesE11,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE11+L,4:6)-lattice(indicesE11,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE11+L,7:9)-lattice(indicesE11,7:9)).^2,2)))).*(lattice(indicesE11+L,7:9)-lattice(indicesE11,7:9))).^2,2);     % L


Epotp(indicesE12,:) = Epotp(indicesE12,:) + 0.5*kshhandle(0.5.*(lattice(indicesE12+B,7:9)+lattice(indicesE12,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE12+B,4:6)-lattice(indicesE12,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE12+B,7:9)-lattice(indicesE12,7:9)).^2,2)))).*(lattice(indicesE12+B,7:9)-lattice(indicesE12,7:9))).^2,2) +... % B
                                        0.5*kshhandle(0.5.*(lattice(indicesE12+C,7:9)+lattice(indicesE12,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE12+C,4:6)-lattice(indicesE12,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE12+C,7:9)-lattice(indicesE12,7:9)).^2,2)))).*(lattice(indicesE12+C,7:9)-lattice(indicesE12,7:9))).^2,2) +... % C
                                        0.5*kshhandle(0.5.*(lattice(indicesE12+E,7:9)+lattice(indicesE12,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE12+E,4:6)-lattice(indicesE12,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE12+E,7:9)-lattice(indicesE12,7:9)).^2,2)))).*(lattice(indicesE12+E,7:9)-lattice(indicesE12,7:9))).^2,2) +... % E
                                        0.5*kshhandle(0.5.*(lattice(indicesE12+G,7:9)+lattice(indicesE12,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE12+G,4:6)-lattice(indicesE12,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE12+G,7:9)-lattice(indicesE12,7:9)).^2,2)))).*(lattice(indicesE12+G,7:9)-lattice(indicesE12,7:9))).^2,2) +... % G
                                        0.5*kshhandle(0.5.*(lattice(indicesE12+H,7:9)+lattice(indicesE12,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE12+H,4:6)-lattice(indicesE12,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE12+H,7:9)-lattice(indicesE12,7:9)).^2,2)))).*(lattice(indicesE12+H,7:9)-lattice(indicesE12,7:9))).^2,2) +... % H
                                        0.5*kshhandle(0.5.*(lattice(indicesE12+L,7:9)+lattice(indicesE12,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE12+L,4:6)-lattice(indicesE12,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE12+L,7:9)-lattice(indicesE12,7:9)).^2,2)))).*(lattice(indicesE12+L,7:9)-lattice(indicesE12,7:9))).^2,2) +... % L
                                        0.5*kshhandle(0.5.*(lattice(indicesE12+N,7:9)+lattice(indicesE12,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE12+N,4:6)-lattice(indicesE12,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE12+N,7:9)-lattice(indicesE12,7:9)).^2,2)))).*(lattice(indicesE12+N,7:9)-lattice(indicesE12,7:9))).^2,2);     % N


Epotp(indicesC1,:) = Epotp(indicesC1,:) + 0.5*kshhandle(0.5.*(lattice(indicesC1+N,7:9)+lattice(indicesC1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC1+N,4:6)-lattice(indicesC1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC1+N,7:9)-lattice(indicesC1,7:9)).^2,2)))).*(lattice(indicesC1+N,7:9)-lattice(indicesC1,7:9))).^2,2) +... % N
                                      0.5*kshhandle(0.5.*(lattice(indicesC1+S,7:9)+lattice(indicesC1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC1+S,4:6)-lattice(indicesC1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC1+S,7:9)-lattice(indicesC1,7:9)).^2,2)))).*(lattice(indicesC1+S,7:9)-lattice(indicesC1,7:9))).^2,2) +... % S
                                      0.5*kshhandle(0.5.*(lattice(indicesC1+U,7:9)+lattice(indicesC1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC1+U,4:6)-lattice(indicesC1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC1+U,7:9)-lattice(indicesC1,7:9)).^2,2)))).*(lattice(indicesC1+U,7:9)-lattice(indicesC1,7:9))).^2,2) +... % U
                                      0.5*kshhandle(0.5.*(lattice(indicesC1+V,7:9)+lattice(indicesC1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC1+V,4:6)-lattice(indicesC1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC1+V,7:9)-lattice(indicesC1,7:9)).^2,2)))).*(lattice(indicesC1+V,7:9)-lattice(indicesC1,7:9))).^2,2);     % V


Epotp(indicesC2,:) = Epotp(indicesC2,:) + 0.5*kshhandle(0.5.*(lattice(indicesC2+M,7:9)+lattice(indicesC2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC2+M,4:6)-lattice(indicesC2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC2+M,7:9)-lattice(indicesC2,7:9)).^2,2)))).*(lattice(indicesC2+M,7:9)-lattice(indicesC2,7:9))).^2,2) +... % M
                                      0.5*kshhandle(0.5.*(lattice(indicesC2+R,7:9)+lattice(indicesC2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC2+R,4:6)-lattice(indicesC2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC2+R,7:9)-lattice(indicesC2,7:9)).^2,2)))).*(lattice(indicesC2+R,7:9)-lattice(indicesC2,7:9))).^2,2) +... % R
                                      0.5*kshhandle(0.5.*(lattice(indicesC2+T,7:9)+lattice(indicesC2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC2+T,4:6)-lattice(indicesC2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC2+T,7:9)-lattice(indicesC2,7:9)).^2,2)))).*(lattice(indicesC2+T,7:9)-lattice(indicesC2,7:9))).^2,2) +... % T
                                      0.5*kshhandle(0.5.*(lattice(indicesC2+U,7:9)+lattice(indicesC2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC2+U,4:6)-lattice(indicesC2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC2+U,7:9)-lattice(indicesC2,7:9)).^2,2)))).*(lattice(indicesC2+U,7:9)-lattice(indicesC2,7:9))).^2,2);     % U


Epotp(indicesC3,:) = Epotp(indicesC3,:) + 0.5*kshhandle(0.5.*(lattice(indicesC3+I,7:9)+lattice(indicesC3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC3+I,4:6)-lattice(indicesC3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC3+I,7:9)-lattice(indicesC3,7:9)).^2,2)))).*(lattice(indicesC3+I,7:9)-lattice(indicesC3,7:9))).^2,2) +... % I
                                      0.5*kshhandle(0.5.*(lattice(indicesC3+O,7:9)+lattice(indicesC3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC3+O,4:6)-lattice(indicesC3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC3+O,7:9)-lattice(indicesC3,7:9)).^2,2)))).*(lattice(indicesC3+O,7:9)-lattice(indicesC3,7:9))).^2,2) +... % O
                                      0.5*kshhandle(0.5.*(lattice(indicesC3+P,7:9)+lattice(indicesC3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC3+P,4:6)-lattice(indicesC3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC3+P,7:9)-lattice(indicesC3,7:9)).^2,2)))).*(lattice(indicesC3+P,7:9)-lattice(indicesC3,7:9))).^2,2) +... % P
                                      0.5*kshhandle(0.5.*(lattice(indicesC3+R,7:9)+lattice(indicesC3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC3+R,4:6)-lattice(indicesC3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC3+R,7:9)-lattice(indicesC3,7:9)).^2,2)))).*(lattice(indicesC3+R,7:9)-lattice(indicesC3,7:9))).^2,2);     % R


Epotp(indicesC4,:) = Epotp(indicesC4,:) + 0.5*kshhandle(0.5.*(lattice(indicesC4+L,7:9)+lattice(indicesC4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC4+L,4:6)-lattice(indicesC4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC4+L,7:9)-lattice(indicesC4,7:9)).^2,2)))).*(lattice(indicesC4+L,7:9)-lattice(indicesC4,7:9))).^2,2) +... % L
                                      0.5*kshhandle(0.5.*(lattice(indicesC4+P,7:9)+lattice(indicesC4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC4+P,4:6)-lattice(indicesC4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC4+P,7:9)-lattice(indicesC4,7:9)).^2,2)))).*(lattice(indicesC4+P,7:9)-lattice(indicesC4,7:9))).^2,2) +... % P
                                      0.5*kshhandle(0.5.*(lattice(indicesC4+Q,7:9)+lattice(indicesC4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC4+Q,4:6)-lattice(indicesC4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC4+Q,7:9)-lattice(indicesC4,7:9)).^2,2)))).*(lattice(indicesC4+Q,7:9)-lattice(indicesC4,7:9))).^2,2) +... % Q
                                      0.5*kshhandle(0.5.*(lattice(indicesC4+S,7:9)+lattice(indicesC4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC4+S,4:6)-lattice(indicesC4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC4+S,7:9)-lattice(indicesC4,7:9)).^2,2)))).*(lattice(indicesC4+S,7:9)-lattice(indicesC4,7:9))).^2,2);     % S


Epotp(indicesC5,:) = Epotp(indicesC5,:) + 0.5*kshhandle(0.5.*(lattice(indicesC5+E,7:9)+lattice(indicesC5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC5+E,4:6)-lattice(indicesC5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC5+E,7:9)-lattice(indicesC5,7:9)).^2,2)))).*(lattice(indicesC5+E,7:9)-lattice(indicesC5,7:9))).^2,2) +... % E
                                      0.5*kshhandle(0.5.*(lattice(indicesC5+G,7:9)+lattice(indicesC5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC5+G,4:6)-lattice(indicesC5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC5+G,7:9)-lattice(indicesC5,7:9)).^2,2)))).*(lattice(indicesC5+G,7:9)-lattice(indicesC5,7:9))).^2,2) +... % G
                                      0.5*kshhandle(0.5.*(lattice(indicesC5+H,7:9)+lattice(indicesC5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC5+H,4:6)-lattice(indicesC5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC5+H,7:9)-lattice(indicesC5,7:9)).^2,2)))).*(lattice(indicesC5+H,7:9)-lattice(indicesC5,7:9))).^2,2) +... % H
                                      0.5*kshhandle(0.5.*(lattice(indicesC5+N,7:9)+lattice(indicesC5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC5+N,4:6)-lattice(indicesC5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC5+N,7:9)-lattice(indicesC5,7:9)).^2,2)))).*(lattice(indicesC5+N,7:9)-lattice(indicesC5,7:9))).^2,2);     % N


Epotp(indicesC6,:) = Epotp(indicesC6,:) + 0.5*kshhandle(0.5.*(lattice(indicesC6+D,7:9)+lattice(indicesC6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC6+D,4:6)-lattice(indicesC6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC6+D,7:9)-lattice(indicesC6,7:9)).^2,2)))).*(lattice(indicesC6+D,7:9)-lattice(indicesC6,7:9))).^2,2) +... % D
                                      0.5*kshhandle(0.5.*(lattice(indicesC6+F,7:9)+lattice(indicesC6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC6+F,4:6)-lattice(indicesC6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC6+F,7:9)-lattice(indicesC6,7:9)).^2,2)))).*(lattice(indicesC6+F,7:9)-lattice(indicesC6,7:9))).^2,2) +... % F
                                      0.5*kshhandle(0.5.*(lattice(indicesC6+G,7:9)+lattice(indicesC6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC6+G,4:6)-lattice(indicesC6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC6+G,7:9)-lattice(indicesC6,7:9)).^2,2)))).*(lattice(indicesC6+G,7:9)-lattice(indicesC6,7:9))).^2,2) +... % G
                                      0.5*kshhandle(0.5.*(lattice(indicesC6+M,7:9)+lattice(indicesC6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC6+M,4:6)-lattice(indicesC6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC6+M,7:9)-lattice(indicesC6,7:9)).^2,2)))).*(lattice(indicesC6+M,7:9)-lattice(indicesC6,7:9))).^2,2);     % M


Epotp(indicesC7,:) = Epotp(indicesC7,:) + 0.5*kshhandle(0.5.*(lattice(indicesC7+A,7:9)+lattice(indicesC7,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC7+A,4:6)-lattice(indicesC7,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC7+A,7:9)-lattice(indicesC7,7:9)).^2,2)))).*(lattice(indicesC7+A,7:9)-lattice(indicesC7,7:9))).^2,2) +... % A
                                      0.5*kshhandle(0.5.*(lattice(indicesC7+B,7:9)+lattice(indicesC7,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC7+B,4:6)-lattice(indicesC7,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC7+B,7:9)-lattice(indicesC7,7:9)).^2,2)))).*(lattice(indicesC7+B,7:9)-lattice(indicesC7,7:9))).^2,2) +... % B
                                      0.5*kshhandle(0.5.*(lattice(indicesC7+D,7:9)+lattice(indicesC7,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC7+D,4:6)-lattice(indicesC7,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC7+D,7:9)-lattice(indicesC7,7:9)).^2,2)))).*(lattice(indicesC7+D,7:9)-lattice(indicesC7,7:9))).^2,2) +... % D
                                      0.5*kshhandle(0.5.*(lattice(indicesC7+I,7:9)+lattice(indicesC7,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC7+I,4:6)-lattice(indicesC7,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC7+I,7:9)-lattice(indicesC7,7:9)).^2,2)))).*(lattice(indicesC7+I,7:9)-lattice(indicesC7,7:9))).^2,2);     % I


Epotp(indicesC8,:) = Epotp(indicesC8,:) + 0.5*kshhandle(0.5.*(lattice(indicesC8+B,7:9)+lattice(indicesC8,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC8+B,4:6)-lattice(indicesC8,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC8+B,7:9)-lattice(indicesC8,7:9)).^2,2)))).*(lattice(indicesC8+B,7:9)-lattice(indicesC8,7:9))).^2,2) +... % B
                                      0.5*kshhandle(0.5.*(lattice(indicesC8+C,7:9)+lattice(indicesC8,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC8+C,4:6)-lattice(indicesC8,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC8+C,7:9)-lattice(indicesC8,7:9)).^2,2)))).*(lattice(indicesC8+C,7:9)-lattice(indicesC8,7:9))).^2,2) +... % C
                                      0.5*kshhandle(0.5.*(lattice(indicesC8+E,7:9)+lattice(indicesC8,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC8+E,4:6)-lattice(indicesC8,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC8+E,7:9)-lattice(indicesC8,7:9)).^2,2)))).*(lattice(indicesC8+E,7:9)-lattice(indicesC8,7:9))).^2,2) +... % E
                                      0.5*kshhandle(0.5.*(lattice(indicesC8+L,7:9)+lattice(indicesC8,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC8+L,4:6)-lattice(indicesC8,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC8+L,7:9)-lattice(indicesC8,7:9)).^2,2)))).*(lattice(indicesC8+L,7:9)-lattice(indicesC8,7:9))).^2,2);     % L


%%

% ---> bend springs

Epotp(indicesinternalbulk,:) = Epotp(indicesinternalbulk,:) + 0.5*kbehandle(0.5.*(lattice(indicesinternalbulk+2,7:9)+lattice(indicesinternalbulk,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalbulk+2,4:6)-lattice(indicesinternalbulk,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalbulk+2,7:9)-lattice(indicesinternalbulk,7:9)).^2,2)))).*(lattice(indicesinternalbulk+2,7:9)-lattice(indicesinternalbulk,7:9))).^2,2) +...
                                                          0.5*kbehandle(0.5.*(lattice(indicesinternalbulk-2,7:9)+lattice(indicesinternalbulk,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalbulk-2,4:6)-lattice(indicesinternalbulk,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalbulk-2,7:9)-lattice(indicesinternalbulk,7:9)).^2,2)))).*(lattice(indicesinternalbulk-2,7:9)-lattice(indicesinternalbulk,7:9))).^2,2) +...
                                                          0.5*kbehandle(0.5.*(lattice(indicesinternalbulk+2*Nx,7:9)+lattice(indicesinternalbulk,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalbulk+2*Nx,4:6)-lattice(indicesinternalbulk,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalbulk+2*Nx,7:9)-lattice(indicesinternalbulk,7:9)).^2,2)))).*(lattice(indicesinternalbulk+2*Nx,7:9)-lattice(indicesinternalbulk,7:9))).^2,2) +...
                                                          0.5*kbehandle(0.5.*(lattice(indicesinternalbulk-2*Nx,7:9)+lattice(indicesinternalbulk,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalbulk-2*Nx,4:6)-lattice(indicesinternalbulk,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalbulk-2*Nx,7:9)-lattice(indicesinternalbulk,7:9)).^2,2)))).*(lattice(indicesinternalbulk-2*Nx,7:9)-lattice(indicesinternalbulk,7:9))).^2,2) +...
                                                          0.5*kbehandle(0.5.*(lattice(indicesinternalbulk+2*Nx*Ny,7:9)+lattice(indicesinternalbulk,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalbulk+2*Nx*Ny,4:6)-lattice(indicesinternalbulk,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalbulk+2*Nx*Ny,7:9)-lattice(indicesinternalbulk,7:9)).^2,2)))).*(lattice(indicesinternalbulk+2*Nx*Ny,7:9)-lattice(indicesinternalbulk,7:9))).^2,2) +...
                                                          0.5*kbehandle(0.5.*(lattice(indicesinternalbulk-2*Nx*Ny,7:9)+lattice(indicesinternalbulk,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalbulk-2*Nx*Ny,4:6)-lattice(indicesinternalbulk,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalbulk-2*Nx*Ny,7:9)-lattice(indicesinternalbulk,7:9)).^2,2)))).*(lattice(indicesinternalbulk-2*Nx*Ny,7:9)-lattice(indicesinternalbulk,7:9))).^2,2);
 
Epotp(indicesF1,:) = Epotp(indicesF1,:) + 0.5*kbehandle(0.5.*(lattice(indicesF1+2,7:9)+lattice(indicesF1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF1+2,4:6)-lattice(indicesF1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF1+2,7:9)-lattice(indicesF1,7:9)).^2,2)))).*(lattice(indicesF1+2,7:9)-lattice(indicesF1,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesF1-2,7:9)+lattice(indicesF1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF1-2,4:6)-lattice(indicesF1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF1-2,7:9)-lattice(indicesF1,7:9)).^2,2)))).*(lattice(indicesF1-2,7:9)-lattice(indicesF1,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesF1+2*Nx,7:9)+lattice(indicesF1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF1+2*Nx,4:6)-lattice(indicesF1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF1+2*Nx,7:9)-lattice(indicesF1,7:9)).^2,2)))).*(lattice(indicesF1+2*Nx,7:9)-lattice(indicesF1,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesF1-2*Nx,7:9)+lattice(indicesF1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF1-2*Nx,4:6)-lattice(indicesF1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF1-2*Nx,7:9)-lattice(indicesF1,7:9)).^2,2)))).*(lattice(indicesF1-2*Nx,7:9)-lattice(indicesF1,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesF1+2*Nx*Ny,7:9)+lattice(indicesF1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF1+2*Nx*Ny,4:6)-lattice(indicesF1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF1+2*Nx*Ny,7:9)-lattice(indicesF1,7:9)).^2,2)))).*(lattice(indicesF1+2*Nx*Ny,7:9)-lattice(indicesF1,7:9))).^2,2);

Epotp(indicesF2,:) = Epotp(indicesF2,:) + 0.5*kbehandle(0.5.*(lattice(indicesF2+2,7:9)+lattice(indicesF2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF2+2,4:6)-lattice(indicesF2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF2+2,7:9)-lattice(indicesF2,7:9)).^2,2)))).*(lattice(indicesF2+2,7:9)-lattice(indicesF2,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesF2-2,7:9)+lattice(indicesF2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF2-2,4:6)-lattice(indicesF2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF2-2,7:9)-lattice(indicesF2,7:9)).^2,2)))).*(lattice(indicesF2-2,7:9)-lattice(indicesF2,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesF2+2*Nx,7:9)+lattice(indicesF2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF2+2*Nx,4:6)-lattice(indicesF2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF2+2*Nx,7:9)-lattice(indicesF2,7:9)).^2,2)))).*(lattice(indicesF2+2*Nx,7:9)-lattice(indicesF2,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesF2+2*Nx*Ny,7:9)+lattice(indicesF2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF2+2*Nx*Ny,4:6)-lattice(indicesF2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF2+2*Nx*Ny,7:9)-lattice(indicesF2,7:9)).^2,2)))).*(lattice(indicesF2+2*Nx*Ny,7:9)-lattice(indicesF2,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesF2-2*Nx*Ny,7:9)+lattice(indicesF2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF2-2*Nx*Ny,4:6)-lattice(indicesF2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF2-2*Nx*Ny,7:9)-lattice(indicesF2,7:9)).^2,2)))).*(lattice(indicesF2-2*Nx*Ny,7:9)-lattice(indicesF2,7:9))).^2,2);
               
Epotp(indicesF3,:) = Epotp(indicesF3,:) + 0.5*kbehandle(0.5.*(lattice(indicesF3-2,7:9)+lattice(indicesF3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF3-2,4:6)-lattice(indicesF3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF3-2,7:9)-lattice(indicesF3,7:9)).^2,2)))).*(lattice(indicesF3-2,7:9)-lattice(indicesF3,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesF3+2*Nx,7:9)+lattice(indicesF3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF3+2*Nx,4:6)-lattice(indicesF3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF3+2*Nx,7:9)-lattice(indicesF3,7:9)).^2,2)))).*(lattice(indicesF3+2*Nx,7:9)-lattice(indicesF3,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesF3-2*Nx,7:9)+lattice(indicesF3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF3-2*Nx,4:6)-lattice(indicesF3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF3-2*Nx,7:9)-lattice(indicesF3,7:9)).^2,2)))).*(lattice(indicesF3-2*Nx,7:9)-lattice(indicesF3,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesF3+2*Nx*Ny,7:9)+lattice(indicesF3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF3+2*Nx*Ny,4:6)-lattice(indicesF3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF3+2*Nx*Ny,7:9)-lattice(indicesF3,7:9)).^2,2)))).*(lattice(indicesF3+2*Nx*Ny,7:9)-lattice(indicesF3,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesF3-2*Nx*Ny,7:9)+lattice(indicesF3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF3-2*Nx*Ny,4:6)-lattice(indicesF3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF3-2*Nx*Ny,7:9)-lattice(indicesF3,7:9)).^2,2)))).*(lattice(indicesF3-2*Nx*Ny,7:9)-lattice(indicesF3,7:9))).^2,2);

Epotp(indicesF4,:) = Epotp(indicesF4,:) + 0.5*kbehandle(0.5.*(lattice(indicesF4+2,7:9)+lattice(indicesF4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF4+2,4:6)-lattice(indicesF4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF4+2,7:9)-lattice(indicesF4,7:9)).^2,2)))).*(lattice(indicesF4+2,7:9)-lattice(indicesF4,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesF4-2,7:9)+lattice(indicesF4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF4-2,4:6)-lattice(indicesF4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF4-2,7:9)-lattice(indicesF4,7:9)).^2,2)))).*(lattice(indicesF4-2,7:9)-lattice(indicesF4,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesF4-2*Nx,7:9)+lattice(indicesF4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF4-2*Nx,4:6)-lattice(indicesF4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF4-2*Nx,7:9)-lattice(indicesF4,7:9)).^2,2)))).*(lattice(indicesF4-2*Nx,7:9)-lattice(indicesF4,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesF4+2*Nx*Ny,7:9)+lattice(indicesF4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF4+2*Nx*Ny,4:6)-lattice(indicesF4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF4+2*Nx*Ny,7:9)-lattice(indicesF4,7:9)).^2,2)))).*(lattice(indicesF4+2*Nx*Ny,7:9)-lattice(indicesF4,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesF4-2*Nx*Ny,7:9)+lattice(indicesF4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF4-2*Nx*Ny,4:6)-lattice(indicesF4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF4-2*Nx*Ny,7:9)-lattice(indicesF4,7:9)).^2,2)))).*(lattice(indicesF4-2*Nx*Ny,7:9)-lattice(indicesF4,7:9))).^2,2);
               
Epotp(indicesF5,:) = Epotp(indicesF5,:) + 0.5*kbehandle(0.5.*(lattice(indicesF5+2,7:9)+lattice(indicesF5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF5+2,4:6)-lattice(indicesF5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF5+2,7:9)-lattice(indicesF5,7:9)).^2,2)))).*(lattice(indicesF5+2,7:9)-lattice(indicesF5,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesF5+2*Nx,7:9)+lattice(indicesF5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF5+2*Nx,4:6)-lattice(indicesF5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF5+2*Nx,7:9)-lattice(indicesF5,7:9)).^2,2)))).*(lattice(indicesF5+2*Nx,7:9)-lattice(indicesF5,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesF5-2*Nx,7:9)+lattice(indicesF5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF5-2*Nx,4:6)-lattice(indicesF5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF5-2*Nx,7:9)-lattice(indicesF5,7:9)).^2,2)))).*(lattice(indicesF5-2*Nx,7:9)-lattice(indicesF5,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesF5+2*Nx*Ny,7:9)+lattice(indicesF5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF5+2*Nx*Ny,4:6)-lattice(indicesF5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF5+2*Nx*Ny,7:9)-lattice(indicesF5,7:9)).^2,2)))).*(lattice(indicesF5+2*Nx*Ny,7:9)-lattice(indicesF5,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesF5-2*Nx*Ny,7:9)+lattice(indicesF5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF5-2*Nx*Ny,4:6)-lattice(indicesF5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF5-2*Nx*Ny,7:9)-lattice(indicesF5,7:9)).^2,2)))).*(lattice(indicesF5-2*Nx*Ny,7:9)-lattice(indicesF5,7:9))).^2,2);
               
Epotp(indicesF6,:) = Epotp(indicesF6,:) + 0.5*kbehandle(0.5.*(lattice(indicesF6+2,7:9)+lattice(indicesF6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF6+2,4:6)-lattice(indicesF6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF6+2,7:9)-lattice(indicesF6,7:9)).^2,2)))).*(lattice(indicesF6+2,7:9)-lattice(indicesF6,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesF6-2,7:9)+lattice(indicesF6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF6-2,4:6)-lattice(indicesF6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF6-2,7:9)-lattice(indicesF6,7:9)).^2,2)))).*(lattice(indicesF6-2,7:9)-lattice(indicesF6,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesF6+2*Nx,7:9)+lattice(indicesF6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF6+2*Nx,4:6)-lattice(indicesF6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF6+2*Nx,7:9)-lattice(indicesF6,7:9)).^2,2)))).*(lattice(indicesF6+2*Nx,7:9)-lattice(indicesF6,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesF6-2*Nx,7:9)+lattice(indicesF6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF6-2*Nx,4:6)-lattice(indicesF6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF6-2*Nx,7:9)-lattice(indicesF6,7:9)).^2,2)))).*(lattice(indicesF6-2*Nx,7:9)-lattice(indicesF6,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesF6-2*Nx*Ny,7:9)+lattice(indicesF6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesF6-2*Nx*Ny,4:6)-lattice(indicesF6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesF6-2*Nx*Ny,7:9)-lattice(indicesF6,7:9)).^2,2)))).*(lattice(indicesF6-2*Nx*Ny,7:9)-lattice(indicesF6,7:9))).^2,2);

Epotp(indicesE1,:) = Epotp(indicesE1,:) + 0.5*kbehandle(0.5.*(lattice(indicesE1+2,7:9)+lattice(indicesE1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE1+2,4:6)-lattice(indicesE1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE1+2,7:9)-lattice(indicesE1,7:9)).^2,2)))).*(lattice(indicesE1+2,7:9)-lattice(indicesE1,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesE1-2,7:9)+lattice(indicesE1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE1-2,4:6)-lattice(indicesE1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE1-2,7:9)-lattice(indicesE1,7:9)).^2,2)))).*(lattice(indicesE1-2,7:9)-lattice(indicesE1,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesE1+2*Nx,7:9)+lattice(indicesE1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE1+2*Nx,4:6)-lattice(indicesE1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE1+2*Nx,7:9)-lattice(indicesE1,7:9)).^2,2)))).*(lattice(indicesE1+2*Nx,7:9)-lattice(indicesE1,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesE1+2*Nx*Ny,7:9)+lattice(indicesE1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE1+2*Nx*Ny,4:6)-lattice(indicesE1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE1+2*Nx*Ny,7:9)-lattice(indicesE1,7:9)).^2,2)))).*(lattice(indicesE1+2*Nx*Ny,7:9)-lattice(indicesE1,7:9))).^2,2);

Epotp(indicesE2,:) = Epotp(indicesE2,:) + 0.5*kbehandle(0.5.*(lattice(indicesE2-2,7:9)+lattice(indicesE2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE2-2,4:6)-lattice(indicesE2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE2-2,7:9)-lattice(indicesE2,7:9)).^2,2)))).*(lattice(indicesE2-2,7:9)-lattice(indicesE2,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesE2+2*Nx,7:9)+lattice(indicesE2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE2+2*Nx,4:6)-lattice(indicesE2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE2+2*Nx,7:9)-lattice(indicesE2,7:9)).^2,2)))).*(lattice(indicesE2+2*Nx,7:9)-lattice(indicesE2,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesE2-2*Nx,7:9)+lattice(indicesE2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE2-2*Nx,4:6)-lattice(indicesE2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE2-2*Nx,7:9)-lattice(indicesE2,7:9)).^2,2)))).*(lattice(indicesE2-2*Nx,7:9)-lattice(indicesE2,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesE2+2*Nx*Ny,7:9)+lattice(indicesE2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE2+2*Nx*Ny,4:6)-lattice(indicesE2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE2+2*Nx*Ny,7:9)-lattice(indicesE2,7:9)).^2,2)))).*(lattice(indicesE2+2*Nx*Ny,7:9)-lattice(indicesE2,7:9))).^2,2);
                 
Epotp(indicesE3,:) = Epotp(indicesE3,:) + 0.5*kbehandle(0.5.*(lattice(indicesE3+2,7:9)+lattice(indicesE3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE3+2,4:6)-lattice(indicesE3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE3+2,7:9)-lattice(indicesE3,7:9)).^2,2)))).*(lattice(indicesE3+2,7:9)-lattice(indicesE3,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesE3-2,7:9)+lattice(indicesE3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE3-2,4:6)-lattice(indicesE3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE3-2,7:9)-lattice(indicesE3,7:9)).^2,2)))).*(lattice(indicesE3-2,7:9)-lattice(indicesE3,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesE3-2*Nx,7:9)+lattice(indicesE3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE3-2*Nx,4:6)-lattice(indicesE3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE3-2*Nx,7:9)-lattice(indicesE3,7:9)).^2,2)))).*(lattice(indicesE3-2*Nx,7:9)-lattice(indicesE3,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesE3+2*Nx*Ny,7:9)+lattice(indicesE3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE3+2*Nx*Ny,4:6)-lattice(indicesE3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE3+2*Nx*Ny,7:9)-lattice(indicesE3,7:9)).^2,2)))).*(lattice(indicesE3+2*Nx*Ny,7:9)-lattice(indicesE3,7:9))).^2,2);

Epotp(indicesE4,:) = Epotp(indicesE4,:) + 0.5*kbehandle(0.5.*(lattice(indicesE4+2,7:9)+lattice(indicesE4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE4+2,4:6)-lattice(indicesE4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE4+2,7:9)-lattice(indicesE4,7:9)).^2,2)))).*(lattice(indicesE4+2,7:9)-lattice(indicesE4,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesE4+2*Nx,7:9)+lattice(indicesE4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE4+2*Nx,4:6)-lattice(indicesE4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE4+2*Nx,7:9)-lattice(indicesE4,7:9)).^2,2)))).*(lattice(indicesE4+2*Nx,7:9)-lattice(indicesE4,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesE4-2*Nx,7:9)+lattice(indicesE4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE4-2*Nx,4:6)-lattice(indicesE4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE4-2*Nx,7:9)-lattice(indicesE4,7:9)).^2,2)))).*(lattice(indicesE4-2*Nx,7:9)-lattice(indicesE4,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesE4+2*Nx*Ny,7:9)+lattice(indicesE4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE4+2*Nx*Ny,4:6)-lattice(indicesE4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE4+2*Nx*Ny,7:9)-lattice(indicesE4,7:9)).^2,2)))).*(lattice(indicesE4+2*Nx*Ny,7:9)-lattice(indicesE4,7:9))).^2,2);

Epotp(indicesE5,:) = Epotp(indicesE5,:) + 0.5*kbehandle(0.5.*(lattice(indicesE5+2,7:9)+lattice(indicesE5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE5+2,4:6)-lattice(indicesE5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE5+2,7:9)-lattice(indicesE5,7:9)).^2,2)))).*(lattice(indicesE5+2,7:9)-lattice(indicesE5,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesE5+2*Nx,7:9)+lattice(indicesE5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE5+2*Nx,4:6)-lattice(indicesE5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE5+2*Nx,7:9)-lattice(indicesE5,7:9)).^2,2)))).*(lattice(indicesE5+2*Nx,7:9)-lattice(indicesE5,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesE5+2*Nx*Ny,7:9)+lattice(indicesE5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE5+2*Nx*Ny,4:6)-lattice(indicesE5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE5+2*Nx*Ny,7:9)-lattice(indicesE5,7:9)).^2,2)))).*(lattice(indicesE5+2*Nx*Ny,7:9)-lattice(indicesE5,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesE5-2*Nx*Ny,7:9)+lattice(indicesE5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE5-2*Nx*Ny,4:6)-lattice(indicesE5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE5-2*Nx*Ny,7:9)-lattice(indicesE5,7:9)).^2,2)))).*(lattice(indicesE5-2*Nx*Ny,7:9)-lattice(indicesE5,7:9))).^2,2);

Epotp(indicesE6,:) = Epotp(indicesE6,:) + 0.5*kbehandle(0.5.*(lattice(indicesE6-2,7:9)+lattice(indicesE6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE6-2,4:6)-lattice(indicesE6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE6-2,7:9)-lattice(indicesE6,7:9)).^2,2)))).*(lattice(indicesE6-2,7:9)-lattice(indicesE6,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesE6+2*Nx,7:9)+lattice(indicesE6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE6+2*Nx,4:6)-lattice(indicesE6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE6+2*Nx,7:9)-lattice(indicesE6,7:9)).^2,2)))).*(lattice(indicesE6+2*Nx,7:9)-lattice(indicesE6,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesE6+2*Nx*Ny,7:9)+lattice(indicesE6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE6+2*Nx*Ny,4:6)-lattice(indicesE6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE6+2*Nx*Ny,7:9)-lattice(indicesE6,7:9)).^2,2)))).*(lattice(indicesE6+2*Nx*Ny,7:9)-lattice(indicesE6,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesE6-2*Nx*Ny,7:9)+lattice(indicesE6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE6-2*Nx*Ny,4:6)-lattice(indicesE6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE6-2*Nx*Ny,7:9)-lattice(indicesE6,7:9)).^2,2)))).*(lattice(indicesE6-2*Nx*Ny,7:9)-lattice(indicesE6,7:9))).^2,2);

Epotp(indicesE7,:) = Epotp(indicesE7,:) + 0.5*kbehandle(0.5.*(lattice(indicesE7-2,7:9)+lattice(indicesE7,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE7-2,4:6)-lattice(indicesE7,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE7-2,7:9)-lattice(indicesE7,7:9)).^2,2)))).*(lattice(indicesE7-2,7:9)-lattice(indicesE7,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesE7-2*Nx,7:9)+lattice(indicesE7,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE7-2*Nx,4:6)-lattice(indicesE7,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE7-2*Nx,7:9)-lattice(indicesE7,7:9)).^2,2)))).*(lattice(indicesE7-2*Nx,7:9)-lattice(indicesE7,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesE7+2*Nx*Ny,7:9)+lattice(indicesE7,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE7+2*Nx*Ny,4:6)-lattice(indicesE7,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE7+2*Nx*Ny,7:9)-lattice(indicesE7,7:9)).^2,2)))).*(lattice(indicesE7+2*Nx*Ny,7:9)-lattice(indicesE7,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesE7-2*Nx*Ny,7:9)+lattice(indicesE7,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE7-2*Nx*Ny,4:6)-lattice(indicesE7,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE7-2*Nx*Ny,7:9)-lattice(indicesE7,7:9)).^2,2)))).*(lattice(indicesE7-2*Nx*Ny,7:9)-lattice(indicesE7,7:9))).^2,2);

Epotp(indicesE8,:) = Epotp(indicesE8,:) + 0.5*kbehandle(0.5.*(lattice(indicesE8+2,7:9)+lattice(indicesE8,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE8+2,4:6)-lattice(indicesE8,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE8+2,7:9)-lattice(indicesE8,7:9)).^2,2)))).*(lattice(indicesE8+2,7:9)-lattice(indicesE8,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesE8-2*Nx,7:9)+lattice(indicesE8,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE8-2*Nx,4:6)-lattice(indicesE8,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE8-2*Nx,7:9)-lattice(indicesE8,7:9)).^2,2)))).*(lattice(indicesE8-2*Nx,7:9)-lattice(indicesE8,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesE8+2*Nx*Ny,7:9)+lattice(indicesE8,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE8+2*Nx*Ny,4:6)-lattice(indicesE8,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE8+2*Nx*Ny,7:9)-lattice(indicesE8,7:9)).^2,2)))).*(lattice(indicesE8+2*Nx*Ny,7:9)-lattice(indicesE8,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesE8-2*Nx*Ny,7:9)+lattice(indicesE8,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE8-2*Nx*Ny,4:6)-lattice(indicesE8,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE8-2*Nx*Ny,7:9)-lattice(indicesE8,7:9)).^2,2)))).*(lattice(indicesE8-2*Nx*Ny,7:9)-lattice(indicesE8,7:9))).^2,2);

Epotp(indicesE9,:) = Epotp(indicesE9,:) + 0.5*kbehandle(0.5.*(lattice(indicesE9+2,7:9)+lattice(indicesE9,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE9+2,4:6)-lattice(indicesE9,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE9+2,7:9)-lattice(indicesE9,7:9)).^2,2)))).*(lattice(indicesE9+2,7:9)-lattice(indicesE9,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesE9-2,7:9)+lattice(indicesE9,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE9-2,4:6)-lattice(indicesE9,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE9-2,7:9)-lattice(indicesE9,7:9)).^2,2)))).*(lattice(indicesE9-2,7:9)-lattice(indicesE9,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesE9+2*Nx,7:9)+lattice(indicesE9,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE9+2*Nx,4:6)-lattice(indicesE9,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE9+2*Nx,7:9)-lattice(indicesE9,7:9)).^2,2)))).*(lattice(indicesE9+2*Nx,7:9)-lattice(indicesE9,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesE9-2*Nx*Ny,7:9)+lattice(indicesE9,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE9-2*Nx*Ny,4:6)-lattice(indicesE9,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE9-2*Nx*Ny,7:9)-lattice(indicesE9,7:9)).^2,2)))).*(lattice(indicesE9-2*Nx*Ny,7:9)-lattice(indicesE9,7:9))).^2,2);

Epotp(indicesE10,:) = Epotp(indicesE10,:) + 0.5*kbehandle(0.5.*(lattice(indicesE10-2,7:9)+lattice(indicesE10,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE10-2,4:6)-lattice(indicesE10,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE10-2,7:9)-lattice(indicesE10,7:9)).^2,2)))).*(lattice(indicesE10-2,7:9)-lattice(indicesE10,7:9))).^2,2) +...
                                        0.5*kbehandle(0.5.*(lattice(indicesE10+2*Nx,7:9)+lattice(indicesE10,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE10+2*Nx,4:6)-lattice(indicesE10,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE10+2*Nx,7:9)-lattice(indicesE10,7:9)).^2,2)))).*(lattice(indicesE10+2*Nx,7:9)-lattice(indicesE10,7:9))).^2,2) +...
                                        0.5*kbehandle(0.5.*(lattice(indicesE10-2*Nx,7:9)+lattice(indicesE10,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE10-2*Nx,4:6)-lattice(indicesE10,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE10-2*Nx,7:9)-lattice(indicesE10,7:9)).^2,2)))).*(lattice(indicesE10-2*Nx,7:9)-lattice(indicesE10,7:9))).^2,2) +...
                                        0.5*kbehandle(0.5.*(lattice(indicesE10-2*Nx*Ny,7:9)+lattice(indicesE10,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE10-2*Nx*Ny,4:6)-lattice(indicesE10,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE10-2*Nx*Ny,7:9)-lattice(indicesE10,7:9)).^2,2)))).*(lattice(indicesE10-2*Nx*Ny,7:9)-lattice(indicesE10,7:9))).^2,2);

Epotp(indicesE11,:) = Epotp(indicesE11,:) + 0.5*kbehandle(0.5.*(lattice(indicesE11+2,7:9)+lattice(indicesE11,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE11+2,4:6)-lattice(indicesE11,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE11+2,7:9)-lattice(indicesE11,7:9)).^2,2)))).*(lattice(indicesE11+2,7:9)-lattice(indicesE11,7:9))).^2,2) +...
                                        0.5*kbehandle(0.5.*(lattice(indicesE11-2,7:9)+lattice(indicesE11,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE11-2,4:6)-lattice(indicesE11,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE11-2,7:9)-lattice(indicesE11,7:9)).^2,2)))).*(lattice(indicesE11-2,7:9)-lattice(indicesE11,7:9))).^2,2) +...
                                        0.5*kbehandle(0.5.*(lattice(indicesE11-2*Nx,7:9)+lattice(indicesE11,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE11-2*Nx,4:6)-lattice(indicesE11,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE11-2*Nx,7:9)-lattice(indicesE11,7:9)).^2,2)))).*(lattice(indicesE11-2*Nx,7:9)-lattice(indicesE11,7:9))).^2,2) +...
                                        0.5*kbehandle(0.5.*(lattice(indicesE11-2*Nx*Ny,7:9)+lattice(indicesE11,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE11-2*Nx*Ny,4:6)-lattice(indicesE11,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE11-2*Nx*Ny,7:9)-lattice(indicesE11,7:9)).^2,2)))).*(lattice(indicesE11-2*Nx*Ny,7:9)-lattice(indicesE11,7:9))).^2,2);

Epotp(indicesE12,:) = Epotp(indicesE12,:) + 0.5*kbehandle(0.5.*(lattice(indicesE12+2,7:9)+lattice(indicesE12,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE12+2,4:6)-lattice(indicesE12,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE12+2,7:9)-lattice(indicesE12,7:9)).^2,2)))).*(lattice(indicesE12+2,7:9)-lattice(indicesE12,7:9))).^2,2) +...
                                        0.5*kbehandle(0.5.*(lattice(indicesE12+2*Nx,7:9)+lattice(indicesE12,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE12+2*Nx,4:6)-lattice(indicesE12,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE12+2*Nx,7:9)-lattice(indicesE12,7:9)).^2,2)))).*(lattice(indicesE12+2*Nx,7:9)-lattice(indicesE12,7:9))).^2,2) +...
                                        0.5*kbehandle(0.5.*(lattice(indicesE12-2*Nx,7:9)+lattice(indicesE12,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE12-2*Nx,4:6)-lattice(indicesE12,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE12-2*Nx,7:9)-lattice(indicesE12,7:9)).^2,2)))).*(lattice(indicesE12-2*Nx,7:9)-lattice(indicesE12,7:9))).^2,2) +...
                                        0.5*kbehandle(0.5.*(lattice(indicesE12-2*Nx*Ny,7:9)+lattice(indicesE12,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesE12-2*Nx*Ny,4:6)-lattice(indicesE12,4:6)).^2,2)))./(sqrt(sum((lattice(indicesE12-2*Nx*Ny,7:9)-lattice(indicesE12,7:9)).^2,2)))).*(lattice(indicesE12-2*Nx*Ny,7:9)-lattice(indicesE12,7:9))).^2,2);

Epotp(indicesC1,:) = Epotp(indicesC1,:) + 0.5*kbehandle(0.5.*(lattice(indicesC1+2,7:9)+lattice(indicesC1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC1+2,4:6)-lattice(indicesC1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC1+2,7:9)-lattice(indicesC1,7:9)).^2,2)))).*(lattice(indicesC1+2,7:9)-lattice(indicesC1,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesC1+2*Nx,7:9)+lattice(indicesC1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC1+2*Nx,4:6)-lattice(indicesC1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC1+2*Nx,7:9)-lattice(indicesC1,7:9)).^2,2)))).*(lattice(indicesC1+2*Nx,7:9)-lattice(indicesC1,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesC1+2*Nx*Ny,7:9)+lattice(indicesC1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC1+2*Nx*Ny,4:6)-lattice(indicesC1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC1+2*Nx*Ny,7:9)-lattice(indicesC1,7:9)).^2,2)))).*(lattice(indicesC1+2*Nx*Ny,7:9)-lattice(indicesC1,7:9))).^2,2);

Epotp(indicesC2,:) = Epotp(indicesC2,:) + 0.5*kbehandle(0.5.*(lattice(indicesC2-2,7:9)+lattice(indicesC2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC2-2,4:6)-lattice(indicesC2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC2-2,7:9)-lattice(indicesC2,7:9)).^2,2)))).*(lattice(indicesC2-2,7:9)-lattice(indicesC2,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesC2+2*Nx,7:9)+lattice(indicesC2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC2+2*Nx,4:6)-lattice(indicesC2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC2+2*Nx,7:9)-lattice(indicesC2,7:9)).^2,2)))).*(lattice(indicesC2+2*Nx,7:9)-lattice(indicesC2,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesC2+2*Nx*Ny,7:9)+lattice(indicesC2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC2+2*Nx*Ny,4:6)-lattice(indicesC2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC2+2*Nx*Ny,7:9)-lattice(indicesC2,7:9)).^2,2)))).*(lattice(indicesC2+2*Nx*Ny,7:9)-lattice(indicesC2,7:9))).^2,2);

Epotp(indicesC3,:) = Epotp(indicesC3,:) + 0.5*kbehandle(0.5.*(lattice(indicesC3-2,7:9)+lattice(indicesC3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC3-2,4:6)-lattice(indicesC3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC3-2,7:9)-lattice(indicesC3,7:9)).^2,2)))).*(lattice(indicesC3-2,7:9)-lattice(indicesC3,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesC3-2*Nx,7:9)+lattice(indicesC3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC3-2*Nx,4:6)-lattice(indicesC3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC3-2*Nx,7:9)-lattice(indicesC3,7:9)).^2,2)))).*(lattice(indicesC3-2*Nx,7:9)-lattice(indicesC3,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesC3+2*Nx*Ny,7:9)+lattice(indicesC3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC3+2*Nx*Ny,4:6)-lattice(indicesC3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC3+2*Nx*Ny,7:9)-lattice(indicesC3,7:9)).^2,2)))).*(lattice(indicesC3+2*Nx*Ny,7:9)-lattice(indicesC3,7:9))).^2,2);

Epotp(indicesC4,:) = Epotp(indicesC4,:) + 0.5*kbehandle(0.5.*(lattice(indicesC4+2,7:9)+lattice(indicesC4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC4+2,4:6)-lattice(indicesC4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC4+2,7:9)-lattice(indicesC4,7:9)).^2,2)))).*(lattice(indicesC4+2,7:9)-lattice(indicesC4,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesC4-2*Nx,7:9)+lattice(indicesC4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC4-2*Nx,4:6)-lattice(indicesC4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC4-2*Nx,7:9)-lattice(indicesC4,7:9)).^2,2)))).*(lattice(indicesC4-2*Nx,7:9)-lattice(indicesC4,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesC4+2*Nx*Ny,7:9)+lattice(indicesC4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC4+2*Nx*Ny,4:6)-lattice(indicesC4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC4+2*Nx*Ny,7:9)-lattice(indicesC4,7:9)).^2,2)))).*(lattice(indicesC4+2*Nx*Ny,7:9)-lattice(indicesC4,7:9))).^2,2);

Epotp(indicesC5,:) = Epotp(indicesC5,:) + 0.5*kbehandle(0.5.*(lattice(indicesC5+2,7:9)+lattice(indicesC5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC5+2,4:6)-lattice(indicesC5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC5+2,7:9)-lattice(indicesC5,7:9)).^2,2)))).*(lattice(indicesC5+2,7:9)-lattice(indicesC5,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesC5+2*Nx,7:9)+lattice(indicesC5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC5+2*Nx,4:6)-lattice(indicesC5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC5+2*Nx,7:9)-lattice(indicesC5,7:9)).^2,2)))).*(lattice(indicesC5+2*Nx,7:9)-lattice(indicesC5,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesC5-2*Nx*Ny,7:9)+lattice(indicesC5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC5-2*Nx*Ny,4:6)-lattice(indicesC5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC5-2*Nx*Ny,7:9)-lattice(indicesC5,7:9)).^2,2)))).*(lattice(indicesC5-2*Nx*Ny,7:9)-lattice(indicesC5,7:9))).^2,2);

Epotp(indicesC6,:) = Epotp(indicesC6,:) + 0.5*kbehandle(0.5.*(lattice(indicesC6-2,7:9)+lattice(indicesC6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC6-2,4:6)-lattice(indicesC6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC6-2,7:9)-lattice(indicesC6,7:9)).^2,2)))).*(lattice(indicesC6-2,7:9)-lattice(indicesC6,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesC6+2*Nx,7:9)+lattice(indicesC6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC6+2*Nx,4:6)-lattice(indicesC6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC6+2*Nx,7:9)-lattice(indicesC6,7:9)).^2,2)))).*(lattice(indicesC6+2*Nx,7:9)-lattice(indicesC6,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesC6-2*Nx*Ny,7:9)+lattice(indicesC6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC6-2*Nx*Ny,4:6)-lattice(indicesC6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC6-2*Nx*Ny,7:9)-lattice(indicesC6,7:9)).^2,2)))).*(lattice(indicesC6-2*Nx*Ny,7:9)-lattice(indicesC6,7:9))).^2,2);

Epotp(indicesC7,:) = Epotp(indicesC7,:) + 0.5*kbehandle(0.5.*(lattice(indicesC7-2,7:9)+lattice(indicesC7,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC7-2,4:6)-lattice(indicesC7,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC7-2,7:9)-lattice(indicesC7,7:9)).^2,2)))).*(lattice(indicesC7-2,7:9)-lattice(indicesC7,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesC7-2*Nx,7:9)+lattice(indicesC7,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC7-2*Nx,4:6)-lattice(indicesC7,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC7-2*Nx,7:9)-lattice(indicesC7,7:9)).^2,2)))).*(lattice(indicesC7-2*Nx,7:9)-lattice(indicesC7,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesC7-2*Nx*Ny,7:9)+lattice(indicesC7,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC7-2*Nx*Ny,4:6)-lattice(indicesC7,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC7-2*Nx*Ny,7:9)-lattice(indicesC7,7:9)).^2,2)))).*(lattice(indicesC7-2*Nx*Ny,7:9)-lattice(indicesC7,7:9))).^2,2);

Epotp(indicesC8,:) = Epotp(indicesC8,:) + 0.5*kbehandle(0.5.*(lattice(indicesC8+2,7:9)+lattice(indicesC8,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC8+2,4:6)-lattice(indicesC8,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC8+2,7:9)-lattice(indicesC8,7:9)).^2,2)))).*(lattice(indicesC8+2,7:9)-lattice(indicesC8,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesC8-2*Nx,7:9)+lattice(indicesC8,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC8-2*Nx,4:6)-lattice(indicesC8,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC8-2*Nx,7:9)-lattice(indicesC8,7:9)).^2,2)))).*(lattice(indicesC8-2*Nx,7:9)-lattice(indicesC8,7:9))).^2,2) +...
                                      0.5*kbehandle(0.5.*(lattice(indicesC8-2*Nx*Ny,7:9)+lattice(indicesC8,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesC8-2*Nx*Ny,4:6)-lattice(indicesC8,4:6)).^2,2)))./(sqrt(sum((lattice(indicesC8-2*Nx*Ny,7:9)-lattice(indicesC8,7:9)).^2,2)))).*(lattice(indicesC8-2*Nx*Ny,7:9)-lattice(indicesC8,7:9))).^2,2);

Epotp(indicesinternalF1,:) = Epotp(indicesinternalF1,:) + 0.5*kbehandle(0.5.*(lattice(indicesinternalF1+2,7:9)+lattice(indicesinternalF1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalF1+2,4:6)-lattice(indicesinternalF1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalF1+2,7:9)-lattice(indicesinternalF1,7:9)).^2,2)))).*(lattice(indicesinternalF1+2,7:9)-lattice(indicesinternalF1,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalF1-2,7:9)+lattice(indicesinternalF1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalF1-2,4:6)-lattice(indicesinternalF1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalF1-2,7:9)-lattice(indicesinternalF1,7:9)).^2,2)))).*(lattice(indicesinternalF1-2,7:9)-lattice(indicesinternalF1,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalF1+2*Nx,7:9)+lattice(indicesinternalF1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalF1+2*Nx,4:6)-lattice(indicesinternalF1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalF1+2*Nx,7:9)-lattice(indicesinternalF1,7:9)).^2,2)))).*(lattice(indicesinternalF1+2*Nx,7:9)-lattice(indicesinternalF1,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalF1-2*Nx,7:9)+lattice(indicesinternalF1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalF1-2*Nx,4:6)-lattice(indicesinternalF1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalF1-2*Nx,7:9)-lattice(indicesinternalF1,7:9)).^2,2)))).*(lattice(indicesinternalF1-2*Nx,7:9)-lattice(indicesinternalF1,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalF1+2*Nx*Ny,7:9)+lattice(indicesinternalF1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalF1+2*Nx*Ny,4:6)-lattice(indicesinternalF1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalF1+2*Nx*Ny,7:9)-lattice(indicesinternalF1,7:9)).^2,2)))).*(lattice(indicesinternalF1+2*Nx*Ny,7:9)-lattice(indicesinternalF1,7:9))).^2,2);

Epotp(indicesinternalF2,:) = Epotp(indicesinternalF2,:) + 0.5*kbehandle(0.5.*(lattice(indicesinternalF2+2,7:9)+lattice(indicesinternalF2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalF2+2,4:6)-lattice(indicesinternalF2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalF2+2,7:9)-lattice(indicesinternalF2,7:9)).^2,2)))).*(lattice(indicesinternalF2+2,7:9)-lattice(indicesinternalF2,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalF2-2,7:9)+lattice(indicesinternalF2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalF2-2,4:6)-lattice(indicesinternalF2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalF2-2,7:9)-lattice(indicesinternalF2,7:9)).^2,2)))).*(lattice(indicesinternalF2-2,7:9)-lattice(indicesinternalF2,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalF2+2*Nx,7:9)+lattice(indicesinternalF2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalF2+2*Nx,4:6)-lattice(indicesinternalF2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalF2+2*Nx,7:9)-lattice(indicesinternalF2,7:9)).^2,2)))).*(lattice(indicesinternalF2+2*Nx,7:9)-lattice(indicesinternalF2,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalF2+2*Nx*Ny,7:9)+lattice(indicesinternalF2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalF2+2*Nx*Ny,4:6)-lattice(indicesinternalF2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalF2+2*Nx*Ny,7:9)-lattice(indicesinternalF2,7:9)).^2,2)))).*(lattice(indicesinternalF2+2*Nx*Ny,7:9)-lattice(indicesinternalF2,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalF2-2*Nx*Ny,7:9)+lattice(indicesinternalF2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalF2-2*Nx*Ny,4:6)-lattice(indicesinternalF2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalF2-2*Nx*Ny,7:9)-lattice(indicesinternalF2,7:9)).^2,2)))).*(lattice(indicesinternalF2-2*Nx*Ny,7:9)-lattice(indicesinternalF2,7:9))).^2,2);
               
Epotp(indicesinternalF3,:) = Epotp(indicesinternalF3,:) + 0.5*kbehandle(0.5.*(lattice(indicesinternalF3-2,7:9)+lattice(indicesinternalF3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalF3-2,4:6)-lattice(indicesinternalF3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalF3-2,7:9)-lattice(indicesinternalF3,7:9)).^2,2)))).*(lattice(indicesinternalF3-2,7:9)-lattice(indicesinternalF3,7:9))).^2,2) +...
                                                       0.5*kbehandle(0.5.*(lattice(indicesinternalF3+2*Nx,7:9)+lattice(indicesinternalF3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalF3+2*Nx,4:6)-lattice(indicesinternalF3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalF3+2*Nx,7:9)-lattice(indicesinternalF3,7:9)).^2,2)))).*(lattice(indicesinternalF3+2*Nx,7:9)-lattice(indicesinternalF3,7:9))).^2,2) +...
                                                       0.5*kbehandle(0.5.*(lattice(indicesinternalF3-2*Nx,7:9)+lattice(indicesinternalF3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalF3-2*Nx,4:6)-lattice(indicesinternalF3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalF3-2*Nx,7:9)-lattice(indicesinternalF3,7:9)).^2,2)))).*(lattice(indicesinternalF3-2*Nx,7:9)-lattice(indicesinternalF3,7:9))).^2,2) +...
                                                       0.5*kbehandle(0.5.*(lattice(indicesinternalF3+2*Nx*Ny,7:9)+lattice(indicesinternalF3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalF3+2*Nx*Ny,4:6)-lattice(indicesinternalF3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalF3+2*Nx*Ny,7:9)-lattice(indicesinternalF3,7:9)).^2,2)))).*(lattice(indicesinternalF3+2*Nx*Ny,7:9)-lattice(indicesinternalF3,7:9))).^2,2) +...
                                                       0.5*kbehandle(0.5.*(lattice(indicesinternalF3-2*Nx*Ny,7:9)+lattice(indicesinternalF3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalF3-2*Nx*Ny,4:6)-lattice(indicesinternalF3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalF3-2*Nx*Ny,7:9)-lattice(indicesinternalF3,7:9)).^2,2)))).*(lattice(indicesinternalF3-2*Nx*Ny,7:9)-lattice(indicesinternalF3,7:9))).^2,2);

Epotp(indicesinternalF4,:) = Epotp(indicesinternalF4,:) + 0.5*kbehandle(0.5.*(lattice(indicesinternalF4+2,7:9)+lattice(indicesinternalF4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalF4+2,4:6)-lattice(indicesinternalF4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalF4+2,7:9)-lattice(indicesinternalF4,7:9)).^2,2)))).*(lattice(indicesinternalF4+2,7:9)-lattice(indicesinternalF4,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalF4-2,7:9)+lattice(indicesinternalF4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalF4-2,4:6)-lattice(indicesinternalF4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalF4-2,7:9)-lattice(indicesinternalF4,7:9)).^2,2)))).*(lattice(indicesinternalF4-2,7:9)-lattice(indicesinternalF4,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalF4-2*Nx,7:9)+lattice(indicesinternalF4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalF4-2*Nx,4:6)-lattice(indicesinternalF4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalF4-2*Nx,7:9)-lattice(indicesinternalF4,7:9)).^2,2)))).*(lattice(indicesinternalF4-2*Nx,7:9)-lattice(indicesinternalF4,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalF4+2*Nx*Ny,7:9)+lattice(indicesinternalF4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalF4+2*Nx*Ny,4:6)-lattice(indicesinternalF4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalF4+2*Nx*Ny,7:9)-lattice(indicesinternalF4,7:9)).^2,2)))).*(lattice(indicesinternalF4+2*Nx*Ny,7:9)-lattice(indicesinternalF4,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalF4-2*Nx*Ny,7:9)+lattice(indicesinternalF4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalF4-2*Nx*Ny,4:6)-lattice(indicesinternalF4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalF4-2*Nx*Ny,7:9)-lattice(indicesinternalF4,7:9)).^2,2)))).*(lattice(indicesinternalF4-2*Nx*Ny,7:9)-lattice(indicesinternalF4,7:9))).^2,2);
               
Epotp(indicesinternalF5,:) = Epotp(indicesinternalF5,:) + 0.5*kbehandle(0.5.*(lattice(indicesinternalF5+2,7:9)+lattice(indicesinternalF5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalF5+2,4:6)-lattice(indicesinternalF5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalF5+2,7:9)-lattice(indicesinternalF5,7:9)).^2,2)))).*(lattice(indicesinternalF5+2,7:9)-lattice(indicesinternalF5,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalF5+2*Nx,7:9)+lattice(indicesinternalF5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalF5+2*Nx,4:6)-lattice(indicesinternalF5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalF5+2*Nx,7:9)-lattice(indicesinternalF5,7:9)).^2,2)))).*(lattice(indicesinternalF5+2*Nx,7:9)-lattice(indicesinternalF5,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalF5-2*Nx,7:9)+lattice(indicesinternalF5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalF5-2*Nx,4:6)-lattice(indicesinternalF5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalF5-2*Nx,7:9)-lattice(indicesinternalF5,7:9)).^2,2)))).*(lattice(indicesinternalF5-2*Nx,7:9)-lattice(indicesinternalF5,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalF5+2*Nx*Ny,7:9)+lattice(indicesinternalF5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalF5+2*Nx*Ny,4:6)-lattice(indicesinternalF5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalF5+2*Nx*Ny,7:9)-lattice(indicesinternalF5,7:9)).^2,2)))).*(lattice(indicesinternalF5+2*Nx*Ny,7:9)-lattice(indicesinternalF5,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalF5-2*Nx*Ny,7:9)+lattice(indicesinternalF5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalF5-2*Nx*Ny,4:6)-lattice(indicesinternalF5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalF5-2*Nx*Ny,7:9)-lattice(indicesinternalF5,7:9)).^2,2)))).*(lattice(indicesinternalF5-2*Nx*Ny,7:9)-lattice(indicesinternalF5,7:9))).^2,2);
               
Epotp(indicesinternalF6,:) = Epotp(indicesinternalF6,:) + 0.5*kbehandle(0.5.*(lattice(indicesinternalF6+2,7:9)+lattice(indicesinternalF6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalF6+2,4:6)-lattice(indicesinternalF6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalF6+2,7:9)-lattice(indicesinternalF6,7:9)).^2,2)))).*(lattice(indicesinternalF6+2,7:9)-lattice(indicesinternalF6,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalF6-2,7:9)+lattice(indicesinternalF6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalF6-2,4:6)-lattice(indicesinternalF6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalF6-2,7:9)-lattice(indicesinternalF6,7:9)).^2,2)))).*(lattice(indicesinternalF6-2,7:9)-lattice(indicesinternalF6,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalF6+2*Nx,7:9)+lattice(indicesinternalF6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalF6+2*Nx,4:6)-lattice(indicesinternalF6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalF6+2*Nx,7:9)-lattice(indicesinternalF6,7:9)).^2,2)))).*(lattice(indicesinternalF6+2*Nx,7:9)-lattice(indicesinternalF6,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalF6-2*Nx,7:9)+lattice(indicesinternalF6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalF6-2*Nx,4:6)-lattice(indicesinternalF6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalF6-2*Nx,7:9)-lattice(indicesinternalF6,7:9)).^2,2)))).*(lattice(indicesinternalF6-2*Nx,7:9)-lattice(indicesinternalF6,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalF6-2*Nx*Ny,7:9)+lattice(indicesinternalF6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalF6-2*Nx*Ny,4:6)-lattice(indicesinternalF6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalF6-2*Nx*Ny,7:9)-lattice(indicesinternalF6,7:9)).^2,2)))).*(lattice(indicesinternalF6-2*Nx*Ny,7:9)-lattice(indicesinternalF6,7:9))).^2,2);

Epotp(indicesinternalE1,:) = Epotp(indicesinternalE1,:) + 0.5*kbehandle(0.5.*(lattice(indicesinternalE1+2,7:9)+lattice(indicesinternalE1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalE1+2,4:6)-lattice(indicesinternalE1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalE1+2,7:9)-lattice(indicesinternalE1,7:9)).^2,2)))).*(lattice(indicesinternalE1+2,7:9)-lattice(indicesinternalE1,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalE1-2,7:9)+lattice(indicesinternalE1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalE1-2,4:6)-lattice(indicesinternalE1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalE1-2,7:9)-lattice(indicesinternalE1,7:9)).^2,2)))).*(lattice(indicesinternalE1-2,7:9)-lattice(indicesinternalE1,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalE1+2*Nx,7:9)+lattice(indicesinternalE1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalE1+2*Nx,4:6)-lattice(indicesinternalE1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalE1+2*Nx,7:9)-lattice(indicesinternalE1,7:9)).^2,2)))).*(lattice(indicesinternalE1+2*Nx,7:9)-lattice(indicesinternalE1,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalE1+2*Nx*Ny,7:9)+lattice(indicesinternalE1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalE1+2*Nx*Ny,4:6)-lattice(indicesinternalE1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalE1+2*Nx*Ny,7:9)-lattice(indicesinternalE1,7:9)).^2,2)))).*(lattice(indicesinternalE1+2*Nx*Ny,7:9)-lattice(indicesinternalE1,7:9))).^2,2);

Epotp(indicesinternalE2,:) = Epotp(indicesinternalE2,:) + 0.5*kbehandle(0.5.*(lattice(indicesinternalE2-2,7:9)+lattice(indicesinternalE2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalE2-2,4:6)-lattice(indicesinternalE2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalE2-2,7:9)-lattice(indicesinternalE2,7:9)).^2,2)))).*(lattice(indicesinternalE2-2,7:9)-lattice(indicesinternalE2,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalE2+2*Nx,7:9)+lattice(indicesinternalE2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalE2+2*Nx,4:6)-lattice(indicesinternalE2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalE2+2*Nx,7:9)-lattice(indicesinternalE2,7:9)).^2,2)))).*(lattice(indicesinternalE2+2*Nx,7:9)-lattice(indicesinternalE2,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalE2-2*Nx,7:9)+lattice(indicesinternalE2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalE2-2*Nx,4:6)-lattice(indicesinternalE2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalE2-2*Nx,7:9)-lattice(indicesinternalE2,7:9)).^2,2)))).*(lattice(indicesinternalE2-2*Nx,7:9)-lattice(indicesinternalE2,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalE2+2*Nx*Ny,7:9)+lattice(indicesinternalE2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalE2+2*Nx*Ny,4:6)-lattice(indicesinternalE2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalE2+2*Nx*Ny,7:9)-lattice(indicesinternalE2,7:9)).^2,2)))).*(lattice(indicesinternalE2+2*Nx*Ny,7:9)-lattice(indicesinternalE2,7:9))).^2,2);
                 
Epotp(indicesinternalE3,:) = Epotp(indicesinternalE3,:) + 0.5*kbehandle(0.5.*(lattice(indicesinternalE3+2,7:9)+lattice(indicesinternalE3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalE3+2,4:6)-lattice(indicesinternalE3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalE3+2,7:9)-lattice(indicesinternalE3,7:9)).^2,2)))).*(lattice(indicesinternalE3+2,7:9)-lattice(indicesinternalE3,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalE3-2,7:9)+lattice(indicesinternalE3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalE3-2,4:6)-lattice(indicesinternalE3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalE3-2,7:9)-lattice(indicesinternalE3,7:9)).^2,2)))).*(lattice(indicesinternalE3-2,7:9)-lattice(indicesinternalE3,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalE3-2*Nx,7:9)+lattice(indicesinternalE3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalE3-2*Nx,4:6)-lattice(indicesinternalE3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalE3-2*Nx,7:9)-lattice(indicesinternalE3,7:9)).^2,2)))).*(lattice(indicesinternalE3-2*Nx,7:9)-lattice(indicesinternalE3,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalE3+2*Nx*Ny,7:9)+lattice(indicesinternalE3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalE3+2*Nx*Ny,4:6)-lattice(indicesinternalE3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalE3+2*Nx*Ny,7:9)-lattice(indicesinternalE3,7:9)).^2,2)))).*(lattice(indicesinternalE3+2*Nx*Ny,7:9)-lattice(indicesinternalE3,7:9))).^2,2);

Epotp(indicesinternalE4,:) = Epotp(indicesinternalE4,:) + 0.5*kbehandle(0.5.*(lattice(indicesinternalE4+2,7:9)+lattice(indicesinternalE4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalE4+2,4:6)-lattice(indicesinternalE4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalE4+2,7:9)-lattice(indicesinternalE4,7:9)).^2,2)))).*(lattice(indicesinternalE4+2,7:9)-lattice(indicesinternalE4,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalE4+2*Nx,7:9)+lattice(indicesinternalE4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalE4+2*Nx,4:6)-lattice(indicesinternalE4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalE4+2*Nx,7:9)-lattice(indicesinternalE4,7:9)).^2,2)))).*(lattice(indicesinternalE4+2*Nx,7:9)-lattice(indicesinternalE4,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalE4-2*Nx,7:9)+lattice(indicesinternalE4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalE4-2*Nx,4:6)-lattice(indicesinternalE4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalE4-2*Nx,7:9)-lattice(indicesinternalE4,7:9)).^2,2)))).*(lattice(indicesinternalE4-2*Nx,7:9)-lattice(indicesinternalE4,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalE4+2*Nx*Ny,7:9)+lattice(indicesinternalE4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalE4+2*Nx*Ny,4:6)-lattice(indicesinternalE4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalE4+2*Nx*Ny,7:9)-lattice(indicesinternalE4,7:9)).^2,2)))).*(lattice(indicesinternalE4+2*Nx*Ny,7:9)-lattice(indicesinternalE4,7:9))).^2,2);

Epotp(indicesinternalE5,:) = Epotp(indicesinternalE5,:) + 0.5*kbehandle(0.5.*(lattice(indicesinternalE5+2,7:9)+lattice(indicesinternalE5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalE5+2,4:6)-lattice(indicesinternalE5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalE5+2,7:9)-lattice(indicesinternalE5,7:9)).^2,2)))).*(lattice(indicesinternalE5+2,7:9)-lattice(indicesinternalE5,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalE5+2*Nx,7:9)+lattice(indicesinternalE5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalE5+2*Nx,4:6)-lattice(indicesinternalE5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalE5+2*Nx,7:9)-lattice(indicesinternalE5,7:9)).^2,2)))).*(lattice(indicesinternalE5+2*Nx,7:9)-lattice(indicesinternalE5,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalE5+2*Nx*Ny,7:9)+lattice(indicesinternalE5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalE5+2*Nx*Ny,4:6)-lattice(indicesinternalE5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalE5+2*Nx*Ny,7:9)-lattice(indicesinternalE5,7:9)).^2,2)))).*(lattice(indicesinternalE5+2*Nx*Ny,7:9)-lattice(indicesinternalE5,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalE5-2*Nx*Ny,7:9)+lattice(indicesinternalE5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalE5-2*Nx*Ny,4:6)-lattice(indicesinternalE5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalE5-2*Nx*Ny,7:9)-lattice(indicesinternalE5,7:9)).^2,2)))).*(lattice(indicesinternalE5-2*Nx*Ny,7:9)-lattice(indicesinternalE5,7:9))).^2,2);

Epotp(indicesinternalE6,:) = Epotp(indicesinternalE6,:) + 0.5*kbehandle(0.5.*(lattice(indicesinternalE6-2,7:9)+lattice(indicesinternalE6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalE6-2,4:6)-lattice(indicesinternalE6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalE6-2,7:9)-lattice(indicesinternalE6,7:9)).^2,2)))).*(lattice(indicesinternalE6-2,7:9)-lattice(indicesinternalE6,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalE6+2*Nx,7:9)+lattice(indicesinternalE6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalE6+2*Nx,4:6)-lattice(indicesinternalE6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalE6+2*Nx,7:9)-lattice(indicesinternalE6,7:9)).^2,2)))).*(lattice(indicesinternalE6+2*Nx,7:9)-lattice(indicesinternalE6,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalE6+2*Nx*Ny,7:9)+lattice(indicesinternalE6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalE6+2*Nx*Ny,4:6)-lattice(indicesinternalE6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalE6+2*Nx*Ny,7:9)-lattice(indicesinternalE6,7:9)).^2,2)))).*(lattice(indicesinternalE6+2*Nx*Ny,7:9)-lattice(indicesinternalE6,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalE6-2*Nx*Ny,7:9)+lattice(indicesinternalE6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalE6-2*Nx*Ny,4:6)-lattice(indicesinternalE6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalE6-2*Nx*Ny,7:9)-lattice(indicesinternalE6,7:9)).^2,2)))).*(lattice(indicesinternalE6-2*Nx*Ny,7:9)-lattice(indicesinternalE6,7:9))).^2,2);

Epotp(indicesinternalE7,:) = Epotp(indicesinternalE7,:) + 0.5*kbehandle(0.5.*(lattice(indicesinternalE7-2,7:9)+lattice(indicesinternalE7,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalE7-2,4:6)-lattice(indicesinternalE7,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalE7-2,7:9)-lattice(indicesinternalE7,7:9)).^2,2)))).*(lattice(indicesinternalE7-2,7:9)-lattice(indicesinternalE7,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalE7-2*Nx,7:9)+lattice(indicesinternalE7,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalE7-2*Nx,4:6)-lattice(indicesinternalE7,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalE7-2*Nx,7:9)-lattice(indicesinternalE7,7:9)).^2,2)))).*(lattice(indicesinternalE7-2*Nx,7:9)-lattice(indicesinternalE7,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalE7+2*Nx*Ny,7:9)+lattice(indicesinternalE7,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalE7+2*Nx*Ny,4:6)-lattice(indicesinternalE7,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalE7+2*Nx*Ny,7:9)-lattice(indicesinternalE7,7:9)).^2,2)))).*(lattice(indicesinternalE7+2*Nx*Ny,7:9)-lattice(indicesinternalE7,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalE7-2*Nx*Ny,7:9)+lattice(indicesinternalE7,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalE7-2*Nx*Ny,4:6)-lattice(indicesinternalE7,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalE7-2*Nx*Ny,7:9)-lattice(indicesinternalE7,7:9)).^2,2)))).*(lattice(indicesinternalE7-2*Nx*Ny,7:9)-lattice(indicesinternalE7,7:9))).^2,2);

Epotp(indicesinternalE8,:) = Epotp(indicesinternalE8,:) + 0.5*kbehandle(0.5.*(lattice(indicesinternalE8+2,7:9)+lattice(indicesinternalE8,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalE8+2,4:6)-lattice(indicesinternalE8,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalE8+2,7:9)-lattice(indicesinternalE8,7:9)).^2,2)))).*(lattice(indicesinternalE8+2,7:9)-lattice(indicesinternalE8,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalE8-2*Nx,7:9)+lattice(indicesinternalE8,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalE8-2*Nx,4:6)-lattice(indicesinternalE8,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalE8-2*Nx,7:9)-lattice(indicesinternalE8,7:9)).^2,2)))).*(lattice(indicesinternalE8-2*Nx,7:9)-lattice(indicesinternalE8,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalE8+2*Nx*Ny,7:9)+lattice(indicesinternalE8,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalE8+2*Nx*Ny,4:6)-lattice(indicesinternalE8,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalE8+2*Nx*Ny,7:9)-lattice(indicesinternalE8,7:9)).^2,2)))).*(lattice(indicesinternalE8+2*Nx*Ny,7:9)-lattice(indicesinternalE8,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalE8-2*Nx*Ny,7:9)+lattice(indicesinternalE8,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalE8-2*Nx*Ny,4:6)-lattice(indicesinternalE8,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalE8-2*Nx*Ny,7:9)-lattice(indicesinternalE8,7:9)).^2,2)))).*(lattice(indicesinternalE8-2*Nx*Ny,7:9)-lattice(indicesinternalE8,7:9))).^2,2);

Epotp(indicesinternalE9,:) = Epotp(indicesinternalE9,:) + 0.5*kbehandle(0.5.*(lattice(indicesinternalE9+2,7:9)+lattice(indicesinternalE9,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalE9+2,4:6)-lattice(indicesinternalE9,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalE9+2,7:9)-lattice(indicesinternalE9,7:9)).^2,2)))).*(lattice(indicesinternalE9+2,7:9)-lattice(indicesinternalE9,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalE9-2,7:9)+lattice(indicesinternalE9,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalE9-2,4:6)-lattice(indicesinternalE9,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalE9-2,7:9)-lattice(indicesinternalE9,7:9)).^2,2)))).*(lattice(indicesinternalE9-2,7:9)-lattice(indicesinternalE9,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalE9+2*Nx,7:9)+lattice(indicesinternalE9,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalE9+2*Nx,4:6)-lattice(indicesinternalE9,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalE9+2*Nx,7:9)-lattice(indicesinternalE9,7:9)).^2,2)))).*(lattice(indicesinternalE9+2*Nx,7:9)-lattice(indicesinternalE9,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalE9-2*Nx*Ny,7:9)+lattice(indicesinternalE9,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalE9-2*Nx*Ny,4:6)-lattice(indicesinternalE9,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalE9-2*Nx*Ny,7:9)-lattice(indicesinternalE9,7:9)).^2,2)))).*(lattice(indicesinternalE9-2*Nx*Ny,7:9)-lattice(indicesinternalE9,7:9))).^2,2);

Epotp(indicesinternalE10,:) = Epotp(indicesinternalE10,:) + 0.5*kbehandle(0.5.*(lattice(indicesinternalE10-2,7:9)+lattice(indicesinternalE10,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalE10-2,4:6)-lattice(indicesinternalE10,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalE10-2,7:9)-lattice(indicesinternalE10,7:9)).^2,2)))).*(lattice(indicesinternalE10-2,7:9)-lattice(indicesinternalE10,7:9))).^2,2) +...
                                                        0.5*kbehandle(0.5.*(lattice(indicesinternalE10+2*Nx,7:9)+lattice(indicesinternalE10,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalE10+2*Nx,4:6)-lattice(indicesinternalE10,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalE10+2*Nx,7:9)-lattice(indicesinternalE10,7:9)).^2,2)))).*(lattice(indicesinternalE10+2*Nx,7:9)-lattice(indicesinternalE10,7:9))).^2,2) +...
                                                        0.5*kbehandle(0.5.*(lattice(indicesinternalE10-2*Nx,7:9)+lattice(indicesinternalE10,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalE10-2*Nx,4:6)-lattice(indicesinternalE10,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalE10-2*Nx,7:9)-lattice(indicesinternalE10,7:9)).^2,2)))).*(lattice(indicesinternalE10-2*Nx,7:9)-lattice(indicesinternalE10,7:9))).^2,2) +...
                                                        0.5*kbehandle(0.5.*(lattice(indicesinternalE10-2*Nx*Ny,7:9)+lattice(indicesinternalE10,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalE10-2*Nx*Ny,4:6)-lattice(indicesinternalE10,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalE10-2*Nx*Ny,7:9)-lattice(indicesinternalE10,7:9)).^2,2)))).*(lattice(indicesinternalE10-2*Nx*Ny,7:9)-lattice(indicesinternalE10,7:9))).^2,2);

Epotp(indicesinternalE11,:) = Epotp(indicesinternalE11,:) + 0.5*kbehandle(0.5.*(lattice(indicesinternalE11+2,7:9)+lattice(indicesinternalE11,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalE11+2,4:6)-lattice(indicesinternalE11,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalE11+2,7:9)-lattice(indicesinternalE11,7:9)).^2,2)))).*(lattice(indicesinternalE11+2,7:9)-lattice(indicesinternalE11,7:9))).^2,2) +...
                                                        0.5*kbehandle(0.5.*(lattice(indicesinternalE11-2,7:9)+lattice(indicesinternalE11,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalE11-2,4:6)-lattice(indicesinternalE11,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalE11-2,7:9)-lattice(indicesinternalE11,7:9)).^2,2)))).*(lattice(indicesinternalE11-2,7:9)-lattice(indicesinternalE11,7:9))).^2,2) +...
                                                        0.5*kbehandle(0.5.*(lattice(indicesinternalE11-2*Nx,7:9)+lattice(indicesinternalE11,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalE11-2*Nx,4:6)-lattice(indicesinternalE11,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalE11-2*Nx,7:9)-lattice(indicesinternalE11,7:9)).^2,2)))).*(lattice(indicesinternalE11-2*Nx,7:9)-lattice(indicesinternalE11,7:9))).^2,2) +...
                                                        0.5*kbehandle(0.5.*(lattice(indicesinternalE11-2*Nx*Ny,7:9)+lattice(indicesinternalE11,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalE11-2*Nx*Ny,4:6)-lattice(indicesinternalE11,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalE11-2*Nx*Ny,7:9)-lattice(indicesinternalE11,7:9)).^2,2)))).*(lattice(indicesinternalE11-2*Nx*Ny,7:9)-lattice(indicesinternalE11,7:9))).^2,2);

Epotp(indicesinternalE12,:) = Epotp(indicesinternalE12,:) + 0.5*kbehandle(0.5.*(lattice(indicesinternalE12+2,7:9)+lattice(indicesinternalE12,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalE12+2,4:6)-lattice(indicesinternalE12,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalE12+2,7:9)-lattice(indicesinternalE12,7:9)).^2,2)))).*(lattice(indicesinternalE12+2,7:9)-lattice(indicesinternalE12,7:9))).^2,2) +...
                                                        0.5*kbehandle(0.5.*(lattice(indicesinternalE12+2*Nx,7:9)+lattice(indicesinternalE12,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalE12+2*Nx,4:6)-lattice(indicesinternalE12,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalE12+2*Nx,7:9)-lattice(indicesinternalE12,7:9)).^2,2)))).*(lattice(indicesinternalE12+2*Nx,7:9)-lattice(indicesinternalE12,7:9))).^2,2) +...
                                                        0.5*kbehandle(0.5.*(lattice(indicesinternalE12-2*Nx,7:9)+lattice(indicesinternalE12,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalE12-2*Nx,4:6)-lattice(indicesinternalE12,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalE12-2*Nx,7:9)-lattice(indicesinternalE12,7:9)).^2,2)))).*(lattice(indicesinternalE12-2*Nx,7:9)-lattice(indicesinternalE12,7:9))).^2,2) +...
                                                        0.5*kbehandle(0.5.*(lattice(indicesinternalE12-2*Nx*Ny,7:9)+lattice(indicesinternalE12,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalE12-2*Nx*Ny,4:6)-lattice(indicesinternalE12,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalE12-2*Nx*Ny,7:9)-lattice(indicesinternalE12,7:9)).^2,2)))).*(lattice(indicesinternalE12-2*Nx*Ny,7:9)-lattice(indicesinternalE12,7:9))).^2,2);

Epotp(indicesinternalC1,:) = Epotp(indicesinternalC1,:) + 0.5*kbehandle(0.5.*(lattice(indicesinternalC1+2,7:9)+lattice(indicesinternalC1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalC1+2,4:6)-lattice(indicesinternalC1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalC1+2,7:9)-lattice(indicesinternalC1,7:9)).^2,2)))).*(lattice(indicesinternalC1+2,7:9)-lattice(indicesinternalC1,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalC1+2*Nx,7:9)+lattice(indicesinternalC1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalC1+2*Nx,4:6)-lattice(indicesinternalC1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalC1+2*Nx,7:9)-lattice(indicesinternalC1,7:9)).^2,2)))).*(lattice(indicesinternalC1+2*Nx,7:9)-lattice(indicesinternalC1,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalC1+2*Nx*Ny,7:9)+lattice(indicesinternalC1,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalC1+2*Nx*Ny,4:6)-lattice(indicesinternalC1,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalC1+2*Nx*Ny,7:9)-lattice(indicesinternalC1,7:9)).^2,2)))).*(lattice(indicesinternalC1+2*Nx*Ny,7:9)-lattice(indicesinternalC1,7:9))).^2,2);

Epotp(indicesinternalC2,:) = Epotp(indicesinternalC2,:) + 0.5*kbehandle(0.5.*(lattice(indicesinternalC2-2,7:9)+lattice(indicesinternalC2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalC2-2,4:6)-lattice(indicesinternalC2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalC2-2,7:9)-lattice(indicesinternalC2,7:9)).^2,2)))).*(lattice(indicesinternalC2-2,7:9)-lattice(indicesinternalC2,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalC2+2*Nx,7:9)+lattice(indicesinternalC2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalC2+2*Nx,4:6)-lattice(indicesinternalC2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalC2+2*Nx,7:9)-lattice(indicesinternalC2,7:9)).^2,2)))).*(lattice(indicesinternalC2+2*Nx,7:9)-lattice(indicesinternalC2,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalC2+2*Nx*Ny,7:9)+lattice(indicesinternalC2,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalC2+2*Nx*Ny,4:6)-lattice(indicesinternalC2,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalC2+2*Nx*Ny,7:9)-lattice(indicesinternalC2,7:9)).^2,2)))).*(lattice(indicesinternalC2+2*Nx*Ny,7:9)-lattice(indicesinternalC2,7:9))).^2,2);

Epotp(indicesinternalC3,:) = Epotp(indicesinternalC3,:) + 0.5*kbehandle(0.5.*(lattice(indicesinternalC3-2,7:9)+lattice(indicesinternalC3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalC3-2,4:6)-lattice(indicesinternalC3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalC3-2,7:9)-lattice(indicesinternalC3,7:9)).^2,2)))).*(lattice(indicesinternalC3-2,7:9)-lattice(indicesinternalC3,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalC3-2*Nx,7:9)+lattice(indicesinternalC3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalC3-2*Nx,4:6)-lattice(indicesinternalC3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalC3-2*Nx,7:9)-lattice(indicesinternalC3,7:9)).^2,2)))).*(lattice(indicesinternalC3-2*Nx,7:9)-lattice(indicesinternalC3,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalC3+2*Nx*Ny,7:9)+lattice(indicesinternalC3,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalC3+2*Nx*Ny,4:6)-lattice(indicesinternalC3,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalC3+2*Nx*Ny,7:9)-lattice(indicesinternalC3,7:9)).^2,2)))).*(lattice(indicesinternalC3+2*Nx*Ny,7:9)-lattice(indicesinternalC3,7:9))).^2,2);

Epotp(indicesinternalC4,:) = Epotp(indicesinternalC4,:) + 0.5*kbehandle(0.5.*(lattice(indicesinternalC4+2,7:9)+lattice(indicesinternalC4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalC4+2,4:6)-lattice(indicesinternalC4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalC4+2,7:9)-lattice(indicesinternalC4,7:9)).^2,2)))).*(lattice(indicesinternalC4+2,7:9)-lattice(indicesinternalC4,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalC4-2*Nx,7:9)+lattice(indicesinternalC4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalC4-2*Nx,4:6)-lattice(indicesinternalC4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalC4-2*Nx,7:9)-lattice(indicesinternalC4,7:9)).^2,2)))).*(lattice(indicesinternalC4-2*Nx,7:9)-lattice(indicesinternalC4,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalC4+2*Nx*Ny,7:9)+lattice(indicesinternalC4,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalC4+2*Nx*Ny,4:6)-lattice(indicesinternalC4,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalC4+2*Nx*Ny,7:9)-lattice(indicesinternalC4,7:9)).^2,2)))).*(lattice(indicesinternalC4+2*Nx*Ny,7:9)-lattice(indicesinternalC4,7:9))).^2,2);

Epotp(indicesinternalC5,:) = Epotp(indicesinternalC5,:) + 0.5*kbehandle(0.5.*(lattice(indicesinternalC5+2,7:9)+lattice(indicesinternalC5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalC5+2,4:6)-lattice(indicesinternalC5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalC5+2,7:9)-lattice(indicesinternalC5,7:9)).^2,2)))).*(lattice(indicesinternalC5+2,7:9)-lattice(indicesinternalC5,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalC5+2*Nx,7:9)+lattice(indicesinternalC5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalC5+2*Nx,4:6)-lattice(indicesinternalC5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalC5+2*Nx,7:9)-lattice(indicesinternalC5,7:9)).^2,2)))).*(lattice(indicesinternalC5+2*Nx,7:9)-lattice(indicesinternalC5,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalC5-2*Nx*Ny,7:9)+lattice(indicesinternalC5,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalC5-2*Nx*Ny,4:6)-lattice(indicesinternalC5,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalC5-2*Nx*Ny,7:9)-lattice(indicesinternalC5,7:9)).^2,2)))).*(lattice(indicesinternalC5-2*Nx*Ny,7:9)-lattice(indicesinternalC5,7:9))).^2,2);

Epotp(indicesinternalC6,:) = Epotp(indicesinternalC6,:) + 0.5*kbehandle(0.5.*(lattice(indicesinternalC6-2,7:9)+lattice(indicesinternalC6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalC6-2,4:6)-lattice(indicesinternalC6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalC6-2,7:9)-lattice(indicesinternalC6,7:9)).^2,2)))).*(lattice(indicesinternalC6-2,7:9)-lattice(indicesinternalC6,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalC6+2*Nx,7:9)+lattice(indicesinternalC6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalC6+2*Nx,4:6)-lattice(indicesinternalC6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalC6+2*Nx,7:9)-lattice(indicesinternalC6,7:9)).^2,2)))).*(lattice(indicesinternalC6+2*Nx,7:9)-lattice(indicesinternalC6,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalC6-2*Nx*Ny,7:9)+lattice(indicesinternalC6,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalC6-2*Nx*Ny,4:6)-lattice(indicesinternalC6,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalC6-2*Nx*Ny,7:9)-lattice(indicesinternalC6,7:9)).^2,2)))).*(lattice(indicesinternalC6-2*Nx*Ny,7:9)-lattice(indicesinternalC6,7:9))).^2,2);

Epotp(indicesinternalC7,:) = Epotp(indicesinternalC7,:) + 0.5*kbehandle(0.5.*(lattice(indicesinternalC7-2,7:9)+lattice(indicesinternalC7,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalC7-2,4:6)-lattice(indicesinternalC7,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalC7-2,7:9)-lattice(indicesinternalC7,7:9)).^2,2)))).*(lattice(indicesinternalC7-2,7:9)-lattice(indicesinternalC7,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalC7-2*Nx,7:9)+lattice(indicesinternalC7,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalC7-2*Nx,4:6)-lattice(indicesinternalC7,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalC7-2*Nx,7:9)-lattice(indicesinternalC7,7:9)).^2,2)))).*(lattice(indicesinternalC7-2*Nx,7:9)-lattice(indicesinternalC7,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalC7-2*Nx*Ny,7:9)+lattice(indicesinternalC7,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalC7-2*Nx*Ny,4:6)-lattice(indicesinternalC7,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalC7-2*Nx*Ny,7:9)-lattice(indicesinternalC7,7:9)).^2,2)))).*(lattice(indicesinternalC7-2*Nx*Ny,7:9)-lattice(indicesinternalC7,7:9))).^2,2);

Epotp(indicesinternalC8,:) = Epotp(indicesinternalC8,:) + 0.5*kbehandle(0.5.*(lattice(indicesinternalC8+2,7:9)+lattice(indicesinternalC8,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalC8+2,4:6)-lattice(indicesinternalC8,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalC8+2,7:9)-lattice(indicesinternalC8,7:9)).^2,2)))).*(lattice(indicesinternalC8+2,7:9)-lattice(indicesinternalC8,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalC8-2*Nx,7:9)+lattice(indicesinternalC8,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalC8-2*Nx,4:6)-lattice(indicesinternalC8,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalC8-2*Nx,7:9)-lattice(indicesinternalC8,7:9)).^2,2)))).*(lattice(indicesinternalC8-2*Nx,7:9)-lattice(indicesinternalC8,7:9))).^2,2) +...
                                                      0.5*kbehandle(0.5.*(lattice(indicesinternalC8-2*Nx*Ny,7:9)+lattice(indicesinternalC8,7:9)),t).*sum(((1-(sqrt(sum((lattice(indicesinternalC8-2*Nx*Ny,4:6)-lattice(indicesinternalC8,4:6)).^2,2)))./(sqrt(sum((lattice(indicesinternalC8-2*Nx*Ny,7:9)-lattice(indicesinternalC8,7:9)).^2,2)))).*(lattice(indicesinternalC8-2*Nx*Ny,7:9)-lattice(indicesinternalC8,7:9))).^2,2);

%%

Epot = sum(Epotp);

return